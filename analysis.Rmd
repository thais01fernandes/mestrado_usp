---
title: Exploratory Analysis of Municipalities in Brazil that have adopted a Fare Free
  Public Transport
author: "Thais Pereira"
date: "`r format(Sys.Date(), format='%d/%m/%Y')`"
output:
    html_document:
      theme: flatly
      self-contained: yes
      toc: yes
      toc_float: yes
      css: 
        - style.css
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}

(knitr::opts_chunk$set(
	echo = FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE
)
) 
```

```{r Pacotes}



library("ggpubr")
library("tidyverse")
library("kableExtra")
library("knitr")
library("tidylog")
library("readxl")
library("geobr")
library("sf")
library("wesanderson")
library("ggplot2")
library("stringr")
library ("abjData")
library("extrafont")
library("lubridate")
library("transformr")
library("reactable")
library("rnaturalearth")
library("rgeos")
library("plotly")
library("ggrepel")
library('googlesheets4')
library("leaflet")
library('ggthemes')
library('rmdformats')
library("janitor")
library("reactablefmtr")
# install.packages("PNADcIBGE")
library(PNADcIBGE)


```


```{r Baixando os dados}

file1 <- "https://raw.githubusercontent.com/thais01fernandes/mestrado_usp/main/dados/banco_completo"
banco_completo <- read_delim(file1, delim = ",", 
                        locale = locale(encoding='UTF-8')) %>% select(-1) %>% 
                        filter(ano_implementacao != 2023 | is.na(ano_implementacao))

file2 <- "https://raw.githubusercontent.com/thais01fernandes/mestrado_usp/main/dados/eleicoes_1"
  eleicoes <- read_delim(file2, delim = ",", 
                             locale = locale(encoding='UTF-8')) %>% select(-1) 
  

file3 <- "https://raw.githubusercontent.com/thais01fernandes/mestrado_usp/main/dados/eleicoes_2"
  eleicoes_1 <- read_delim(file3, delim = ",", 
                             locale = locale(encoding='UTF-8')) %>% select(-1) 
  

file4 <- "https://raw.githubusercontent.com/thais01fernandes/mestrado_usp/main/dados/eleicoes_3"
  eleicoes_2 <- read_delim(file4, delim = ",", 
                             locale = locale(encoding='UTF-8')) %>% select(-1) 


```

## **Abstract**

This report analyse data from 65 Brazilian cities that have adopted the
full fare exemption on public transport, more popularly known in Brazil
as the "Tarifa Zero", a term that will be used in this report to refer
to this policy. For the selection of cases, three criteria were used: i.
The policy was implemented in all transport networks in the city; ii. It
is available to all users and; iii. it was not discontinued until
December 2022. We intend to present an exploratory analysis of public
data about the studied municipalities and characterize them by checking
if there is homogeneity in their economic and social characteristics, in
addition to comparing them with all others that have not adopted the
policy, with the objective to understand the differences and disparities
between the two groups of cities, based on Political Science Teories, in
order to undertand why this policy was implemented.

## **Descriptive Analysis**

## 1. General data about the municipalities

```{r Tabela inicial, fig.align = 'center', out.width = "60%"}

# tabela de apresentação dos municípios estudados 
# tabela com reactable: 
  
  options(scipen=999)
  banco_completo  %>% 
  filter(tarifa_zero == "sim") %>% 
  select(nome_da_uf, 
         nome_do_municipio, 
         classe_pop, 
         produto_interno_bruto_a_precos_correntes_r_1_000,
         produto_interno_bruto_per_capita_a_precos_correntes_r_1_00, 
         pmpob, prosperidade_social,  
         taxa_urbanizacao, 
         ar_mun_2022, 
         densidade_demografica, 
         gini, 
         theil, 
         idhm_class, 
         idhm_e_class, 
         idhm_r_class, 
         idhm_l_class, 
         ivs_class, 
         ivs_infra_urbana_class, 
         ivs_cap_class, 
         ivs_renda_trab_class) %>% 
  mutate_if(is.character, str_to_title) %>% 
  mutate(pmpob = pmpob/100) %>% 
  reactable(
      defaultPageSize = 5,
      searchable = TRUE,
      outlined = FALSE, 
      showPageInfo = TRUE, 
      showPageSizeOptions = TRUE,
      defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#c18d83")),
      columns = list(
      nome_da_uf = colDef("Federative Unit", minWidth = 105, align = "center"),
      nome_do_municipio = colDef("City", minWidth = 120, align = "center"),
      classe_pop = colDef("Population Class",  minWidth = 120, align = "center"),
      produto_interno_bruto_a_precos_correntes_r_1_000 = colDef("GDP" , format = colFormat(prefix = "R$ ", separators = TRUE), minWidth = 160),
      produto_interno_bruto_per_capita_a_precos_correntes_r_1_00 = colDef("GDP Per Capta Income" , format = colFormat(prefix = "R$ ", separators = TRUE), minWidth = 150),
      prosperidade_social = colDef("Social Prosperity", minWidth = 150),
      pmpob = colDef("% of Poor" ,  format = colFormat(percent = TRUE, digits = 1), minWidth = 120), 
      taxa_urbanizacao = colDef("Urbanization Rate" , format = colFormat(percent = TRUE, digits = 1), minWidth = 120),
      gini = colDef("Gini" ,  minWidth = 100),
      theil = colDef("Theil-L" ,  minWidth = 100),
      idhm_class = colDef("Municipal Human Development Index (MHDI)" ,  minWidth = 150),
      idhm_e_class = colDef("MHDI Education" ,  minWidth = 100),
      idhm_r_class = colDef("MHDI Income" ,  minWidth = 100), 
      idhm_l_class  = colDef("MHDI Longevidade" , minWidth = 120),
      ivs_class = colDef("Social Vulnerability Index (SVI)" , minWidth = 150), 
      ivs_infra_urbana_class = colDef("SVI Urban Infrastructure" , minWidth = 150), 
      ivs_cap_class = colDef("SVI Human Capital" , minWidth = 150), 
      ivs_renda_trab_class = colDef("SVI Income and Work" , minWidth = 150), 
      ar_mun_2022 = colDef("Territorial Area" , format = colFormat(suffix = " km²", separators = TRUE), minWidth = 150),
      densidade_demografica = colDef("Demographic Density" , format = colFormat(suffix = " hab/km²", separators = TRUE, digits = 3), minWidth = 150),
      pageSizeOptions = c(5,10,15,20,25,30), bordered = TRUE, striped = FALSE, highlight = TRUE))
     
```

## 2. Localization of municipalities

The map below shows us the location of the cities, the points represent
the municipalities:

```{r eval=FALSE, include=FALSE}

# Baixando dados para o mapa com Geobr 

# Download dos Estados e Municípios: 

muni_geobr_1 <- read_municipality(code_muni="all", year=2018) %>%  as.tibble()

geo_ufs <- read_state(code_state = 'all', year = 2018) %>% as.tibble()

geo_ufs %>%  select(geom)

# Estados: 

munic_isencao_tarifa_uf <- banco_completo %>% 
  select(uf_x,tarifa_zero) %>% 
  distinct() %>% 
  rename(code_state=uf_x)

geo_ufs_2 <- geo_ufs  %>% 
  left_join(munic_isencao_tarifa_uf, by = c("code_state")) %>% 
  replace(is.na("tarifa_zero"), "não")

# municipios: 

munic_isencao_tarifa_muni <- banco_completo  %>% 
  rename(code_muni= cod_munic) %>% 
  select(code_muni,tarifa_zero) %>% 
  distinct()

muni_geobr_3 <- muni_geobr_1 %>% 
  left_join(munic_isencao_tarifa_muni, by = c("code_muni")) %>% 
  replace(is.na("tarifa_zero"), "não") %>% 
  st_centroid() %>% 
  filter(tarifa_zero == "sim") %>% 
  rename (Municipio = name_muni)


```


```{r Mapa dos municipios, fig.align = 'center', out.width = "90%"}



# gráfico de mapa colocando os municípios dentro de seus respectivos estados:
# 
# geo_ufs_2 %>% 
# st_as_sf(coords=c("geom")) %>%
# ggplot() +
# geom_sf(aes(geometry = geom,
#            fill = as.character(tarifa_zero)), color = "white") +
# geom_sf(data=muni_geobr_3) +
# theme_light()+
# scale_fill_manual(name = "Tarifa Zero?", values = c("#c57d4b", "#7e9563"), labels = c("Não", "Sim")) +
# theme(legend.text = element_text(family = "serif", size = 12, hjust = 0.5, colour = "black"), 
#       legend.title = element_text(family = "serif", size = 12, hjust = 0.5, colour = "black"))


```

The map below shows us more detailed the location of the cities

```{r leaflet map,  fig.align = 'center', out.width = "90%"}

# Primeiro precisamos dos dados de latitude e longitude das cidades analisadas. 
urlfile <- "https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/master/csv/municipios.csv"
cities_lat_lng <- read.csv(urlfile,encoding = "UTF-8")
# é necessário se certificar que o código de cada cidade estará em formato de texto, para o que a função left_join funcione. 
cities_lat_lng$codigo_ibge <- as.double(cities_lat_lng$codigo_ibge)

ffpt_muni_5 <- banco_completo %>% rename(codigo_ibge = cod_munic) %>% 
  left_join(cities_lat_lng, by = "codigo_ibge")

tarifa_zero <- ffpt_muni_5 %>% filter(tarifa_zero == "sim") %>% select(latitude, longitude, nome_do_municipio)

  leaflet(tarifa_zero) %>%
  addTiles() %>% 
  addMarkers(popup= tarifa_zero$nome_do_municipio)



```

## 3. Region of municipalities

```{r Região dos Municípios,fig.align = 'center', out.width = "50%"}

# Tabela com a Região dos Municípios

  banco_completo  %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate(regiao = trimws(regiao)) %>% 
  group_by(regiao) %>%
  tally() %>% 
  reactable(
      outlined = F, 
      fullWidth = F,
      bordered = T,
      striped = F,
      defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#c18d83")),
      columns = list(
      regiao = colDef("Region", minWidth = 120, align = "center"),
      n = colDef("Municipalities with Tarifa Zero", minWidth = 300, align = "center")))




```

## 4. State of municipalities

```{r UF dos municípios, fig.align = 'center', out.width = "50%"}

# Tabela com a UF dos municípios 

  banco_completo  %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate(nome_da_uf = trimws(nome_da_uf)) %>% 
  group_by(nome_da_uf) %>%
  tally() %>%
  arrange(-n) %>% 
  reactable(
      outlined = F, 
      fullWidth = F,
      bordered = TRUE,
      striped = F,
     defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#c18d83")),
      columns = list(
      nome_da_uf = colDef("Federative Unit", minWidth = 150, align = "center"),
      n = colDef("Municipalities with Tarifa Zero", minWidth = 300, align = "center")))



```

## 5. Population Class

```{r}

  banco_completo %>% 
  mutate(classe_pop = factor(classe_pop, levels = c("Up to 5.000", 
                                                    "5.000 up to 10.000", 
                                                    "10.000 up to 20.000", 
                                                    "20.000 up to 50.000",
                                                    "50.000 up to 100.000", 
                                                    "100.000 up to 500.000", 
                                                    "Greater than 500.000", ordered = TRUE))) %>% 
  group_by(tarifa_zero, classe_pop) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  mutate(classe_pop = trimws(classe_pop)) %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% 
  filter(!is.na(classe_pop)) %>% 
  mutate(tarifa_zero = case_when(tarifa_zero == "sim" ~ "Municípios com Tarifa Zero", 
                                 tarifa_zero == "nao"~ "Municípios sem Tarifa Zero", TRUE ~ tarifa_zero)) %>% 
  ggplot() +
  geom_col(aes(x = reorder(classe_pop, pct), y =  pct, fill = tarifa_zero), width = 1,colour="white", alpha = 0.6) + 
  xlab("") +
  ylab("") +
  ggtitle( "") +
  facet_wrap(~tarifa_zero)+
  scale_fill_manual(name = "", values = c("gray22", "gray22"), labels = element_blank()) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  geom_label(aes(x = classe_pop, y = pct, group = tarifa_zero, label = scales::percent(pct, accuracy = 2)), 
             position = position_identity(),family = "serif", size = 4, colour = "white", fill = "#c18d83", face = "bold")+
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#c18d83"),
    strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "Lora", size = 13),
    axis.text.y=element_text(size = 10, family = "Lora"),
    axis.text.x=element_blank(),
    legend.position="none")+
    coord_flip() 


```

## 4. Year of Implementation

```{r}

banco_completo %>% 
filter(tarifa_zero == "sim") %>% 
mutate(ano_implementacao_classe = case_when(ano_implementacao <= 1998 ~ "Until 2000s", 
                                  ano_implementacao >= 2001 & ano_implementacao  <= 2009 ~ "Between 2001 and 2009",
                                  ano_implementacao >= 2010 & ano_implementacao <= 2015 ~  "Between 2010 and 2015", 
                                  ano_implementacao >= 2016 & ano_implementacao <= 2020 ~ "Between 2016 and 2020", 
                                  ano_implementacao >= 2020  ~ "After 2021", 
                                  TRUE ~ "NA")) %>% 
mutate(ano_implementacao_classe = factor(ano_implementacao_classe, levels = c("Until 2000s", 
                                                                          "Between 2001 and 2009", 
                                                                          "Between 2010 and 2015", 
                                                                          "Between 2016 and 2020",
                                                                          "After 2021", ordered = T))) %>% 
group_by(ano_implementacao_classe) %>% 
tally() %>% 
mutate(pct = n/sum(n)) %>% 
ggplot() +
  geom_col(aes(x = reorder(ano_implementacao_classe, pct), y =  pct), width = 1,colour="white", alpha = 0.6) + 
  xlab("") +
  ylab("") +
  ggtitle( "") +
  scale_fill_manual(name = "", values = c("gray22", "gray22"), labels = element_blank()) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  geom_label(aes(x = ano_implementacao_classe, y = pct, label = scales::percent(pct, accuracy = 2)), 
             position = position_identity(),family = "serif", size = 4, colour = "white", fill = "#c18d83", face = "bold")+
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#c18d83"),
    strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "Lora", size = 13),
    axis.text.y=element_text(size = 10, family = "Lora"),
    axis.text.x=element_blank(),
    legend.position="none")+
    coord_flip() 

```

------------------------------------------------------------------------

## **Exploratory Analysis**

## 1.Análise da Teoria do Eleitor Mediano

**1° Premissa:** "Quanto maior a desigualdade, maior a exigência por
serviços públicos e consequente aumento do gasto público. Portanto,
cidades com tarifa zero devem ser mais desiguais do que cidades sem essa
política."

Para verificar se essa premissa de fato pode nos ajudar a explicar a
tarifa zero, vejamos primeiro o Gini e o Theil-L, ambos são índices de
desigualdade amplamente utilizados, medem o grau de concentração de
renda em determinado grupo e variam de 0 a 1, sendo 0 uma situação de
completa igualdade e 1 uma situação de completa desigualdade, nesse caso
estão usando dados do censo de 2010.

```{r Indice de Gini e Theil media geral}

# Indíce de Gini médias

media_indice_gini_tf <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(median(gini)) %>% 
  round(digits = 2) %>% 
  pull()

media_indice_gini_geral <- banco_completo %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(median(gini, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()

# Indíce de  Theil 

media_indice_theil_tf <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(median(theil)) %>% 
  round(digits = 2) %>% 
  pull()

media_indice_theil_geral <- banco_completo %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(median(theil, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()



```

degree of income concentration in a given group and range from 0 to 1, 0
being a situation of complete equality, and 1 being a situation of
complete inequality, in addition both are using data from the 2010
census. The general median of the Gini index in the studied cities is
`r media_indice_gini_tf`, while for municipalities without a Zero Tariff
it is `r media_indice_gini_geral`. There is only a small difference in
the averages. And the same is true for the Theil-L index, where the
median in the first group is `r media_indice_theil_tf`, while in the
second group it is `r media_indice_theil_geral`, but similarly the
municipalities with Tarifa Zero present values that indicate less social
inequality. Below we can see the distribution graph of the values of the
two indexes for all the municipalities with a Tarifa Zero:

```{r Gráfico GINI e Theil 1, fig.align = 'center', out.width = "70%", dpi=300}


# Labels: 

label_gini_theil <- banco_completo %>% 
   pivot_longer(cols = c("gini", "theil")) %>%
    mutate(name = case_when(
    name == "gini" ~ "Gini",
    name == "theil" ~ "Theil-L")) %>% 
    group_by(name, tarifa_zero) %>% 
    summarise(value = median(value, na.rm = TRUE))

# Gráficos


banco_completo %>% 
 pivot_longer(cols = c("gini", "theil")) %>%
  mutate(name = case_when(
    name == "gini" ~ "Gini",
    name == "theil" ~ "Theil-L")) %>% 
    ggplot() +
    geom_boxplot(aes(x = tarifa_zero, y = value, fill = tarifa_zero), colour="black", alpha = 0.9) +
    geom_label(data = label_gini_theil, aes(tarifa_zero, value, label = value), 
              vjust = 0.5, size = 3) + 
  facet_wrap(~name) +
  theme_light() +
  ggtitle("Boxplot do Índice de Gini e de Theil") +
  xlab("") +
  ylab("") +
  labs(caption = "Fonte: IBGE, 2010 
                  Elaboração Própria") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#c57d4b", "#7e9563"), labels = c("Não", "Sim"))+ 
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#579296"),
          plot.caption = element_text(family = "serif", size = 10),
  strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 14),
    axis.text.x=element_blank(),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.position = "bottom")



```

Tabela Separandos os valores por UF:

```{r fig.align = 'center', out.width = "70%", dpi=300}

  ffpt <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  select(regiao, gini, theil) %>% 
  group_by(regiao) %>% 
  summarise(media_gini_tf = median(gini), media_theil_tf = median(theil))



# munic sem ffpt:

 tabela_desigualdade <- banco_completo %>% 
  filter(tarifa_zero == "não") %>%
  select(regiao, gini, theil) %>% 
  group_by(regiao) %>% 
  summarise(media_gini_geral = median(gini), media_theil_geral = median(theil)) %>% 
  left_join(ffpt, by = "regiao") %>% 
  select(regiao, media_gini_geral, media_gini_tf, media_theil_geral, media_theil_tf) %>% 
      reactable(
      fullWidth = F,
      defaultColDef = colDef(
      align = "center"),
      columns = list(
      regiao = colDef("Região", minWidth = 130),
      media_gini_tf = colDef("Cidades com Tarifa Zero", minWidth = 130),
      media_gini_geral = colDef("Cidades sem Tarifa Zero", minWidth = 130),
      media_theil_tf = colDef("Cidades com Tarifa Zero", minWidth = 130),
     media_theil_geral = colDef("Cidades sem Tarifa Zero", minWidth = 130)),
    columnGroups = list(
    colGroup(name = "Índice de Gini", columns = c("media_gini_tf", "media_gini_geral" )),
    colGroup(name = "Índice de Theil", columns = c("media_theil_geral", "media_theil_tf"))))
 
 tabela_desigualdade %>% 
     add_source("Fonte: IBGE, 2010", font_size = 12, align = "left", margin = margin(t = 12))  


```

**2° Premissa:** "Quanto menor a riqueza medida através do PIB, maior a
demanda por políticas redistributivas. Dessa forma, cidades com tarifa
zero dispõem de menor PIB per capita do que cidades sem essa política."

Para essa análise fizemos um corte comparando apenas as cidades com até
150 mil reais de PIB per capta, tanto com tarifa zero quanto sem tarifa
zero. Isso não significa retirar muitas cidades da base de dados já que
99,45% das cidades sem tarifa zero (e com menos de 300 mil habitantes)
estão dentro desse valor de PIB per capita, no caso das cidades com
tarifa zero, isso representa 96,4% das cidades, essa foi uma forma de
retirar os valores discrepantes da análise e torná-la mais evidente.

```{r PIB Gráfico, fig.align = 'center', out.width = "70%", dpi=300}


# labels: 

label_pib <- banco_completo %>% 
  rename(pib_per_capta = produto_interno_bruto_per_capita_a_precos_correntes_r_1_00) %>% 
  filter(pib_per_capta < 150000) %>% 
  group_by(tarifa_zero) %>% 
  summarise(pib_per_capta = median(pib_per_capta)) %>% 
  mutate(pib_per_capta = round(pib_per_capta))


# Gráfico

banco_completo %>% 
  rename(pib_per_capta = produto_interno_bruto_per_capita_a_precos_correntes_r_1_00) %>% 
  filter(pib_per_capta < 150000) %>% 
  ggplot() +
  geom_boxplot(aes(x = tarifa_zero, y = pib_per_capta, fill = tarifa_zero), colour="black", alpha = 0.9) + 
  geom_label(data = label_pib, aes(x = tarifa_zero, y = pib_per_capta, label = scales::dollar(prefix = "R$ ", round(pib_per_capta, 1))), size = 3) +
  theme_light() +
  xlab("") +
  ylab("") +
  ggtitle("Boxplot do PIB per capta") +
  labs(caption = "Fonte: IBGE, 2020 
                  Elaboração Própria") +
  scale_y_continuous(
  labels = scales::label_dollar(prefix = "R$ ",
                                  big.mark = ".")) + 
  scale_fill_manual(name = "Tarifa Zero?", values = c("#c57d4b", "#7e9563"), labels = c("Não", "Sim"))+ 
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          plot.caption = element_text(family = "serif", size = 10),
    text = element_text(family = "serif", size = 14),
    axis.text.x=element_blank(),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.position = "bottom")



```

```{r}

# Medianas do PIB

media_indice_pib_tf <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  filter(produto_interno_bruto_per_capita_a_precos_correntes_r_1_00 < 150000) %>% 
  summarize(median(produto_interno_bruto_per_capita_a_precos_correntes_r_1_00)) %>% 
  round(digits = 3) %>% 
  pull()

media_indice_pib_geral <- banco_completo %>% 
  filter(tarifa_zero != "sim") %>% 
  filter(produto_interno_bruto_per_capita_a_precos_correntes_r_1_00 < 150000) %>% 
  summarize(median(produto_interno_bruto_per_capita_a_precos_correntes_r_1_00, na.rm = TRUE)) %>% 
  round(digits = 3) %>% 
  pull()


```



Tabela Separandos os valores por UF:

```{r PIB tabela}

ffpt <- banco_completo %>% 
  rename(pib_per_capta = produto_interno_bruto_per_capita_a_precos_correntes_r_1_00) %>% 
  filter(pib_per_capta < 150000) %>% 
  filter(tarifa_zero == "sim") %>% 
  select(regiao, pib_per_capta) %>% 
  group_by(regiao) %>% 
  summarise(media_pib = median(pib_per_capta))


# munic sem ffpt:

  banco_completo %>% 
  rename(pib_per_capta = produto_interno_bruto_per_capita_a_precos_correntes_r_1_00) %>% 
  filter(pib_per_capta < 150000) %>%
  filter(tarifa_zero == "não") %>% 
  select(regiao, pib_per_capta) %>% 
  group_by(regiao) %>% 
  summarise(media_pib = median(pib_per_capta)) %>% 
  left_join(ffpt, by = "regiao") %>% 
  select(regiao, media_pib.x, media_pib.y) %>% 
      reactable(
      fullWidth = F,
      defaultColDef = colDef(
      align = "center"),
      columns = list(
      regiao = colDef("Região", minWidth = 130),
      media_pib.y = colDef("Cidades com Tarifa Zero", format = colFormat(prefix = "R$ ", separators = TRUE), minWidth = 130),
      media_pib.x = colDef("Cidades sem Tarifa Zero", format = colFormat(prefix = "R$ ", separators = TRUE),  minWidth = 130)))

  


```

**3° premissa** Quanto maior a variedade de espectros políticos de partidos que adotam a política, mais provável ela não ter uma lógica partidária e sim eleitoral. Se essa premissa for verdadeira esperamos ter uma distribuição variada de espectros políticos que adotaram a tarifa zero.  


```{r}

# cidade que a eleição do prefeito que implantou foi em 2008

eleicao_2000 <- eleicoes_1 %>% filter(nome_munic == "Ivaipora" | 
                                      nome_munic == "Faxinal" |
                                      nome_munic == "Agudos" |
                                      nome_munic == "Macatuba") %>% 
  select(nome_munic, x2000.y,  x2000.x) %>% 
  rename(`Partido do Prefeito que Implementou a Política` = x2000.y,
         `Ideologia do Partido do Prefeito que Implementou a Política` = x2000.x)


eleicao_2004 <- eleicoes_1 %>% filter(nome_munic == "Aruana"|
                                      nome_munic == "Holambra") %>% 
  select(nome_munic, x2004.y,  x2004.x) %>% 
  rename(`Partido do Prefeito que Implementou a Política` = x2004.y,
         `Ideologia do Partido do Prefeito que Implementou a Política` = x2004.x)

# cidade que a eleição do prefeito que implantou foi em 2008

eleicao_2008 <- eleicoes_1 %>% filter(nome_munic == "Wenceslau Braz" |
                      nome_munic == "Holambra" |
                      nome_munic == "Euzebio" | 
                      nome_munic == "Muzambinho" | 
                      nome_munic == "Pitanga" |
                      nome_munic == "Ilha Solteira" |
                      nome_munic == "Presidente Kennedy") %>% 
  select(nome_munic, x2008.y, x2008.x) %>% 
  rename(`Partido do Prefeito que Implementou a Política` = x2008.y, 
         `Ideologia do Partido do Prefeito que Implementou a Política` = x2008.x)

# cidade que a eleição do prefeito que implantou foi em 2012

eleicao_2012 <- eleicoes_1 %>% filter(nome_munic == "Silva Jardim" |
                      nome_munic == "Dourado" | 
                      nome_munic == "Marica" | 
                      nome_munic == "Anicuns" |
                      nome_munic == "Itatiaiucu") %>% 
  select(nome_munic, x2012.y,  x2012.x) %>% 
  rename(`Partido do Prefeito que Implementou a Política` = x2012.y, 
         `Ideologia do Partido do Prefeito que Implementou a Política` = x2012.x)

# cidade que a eleição do prefeito que implantou foi em 2016

eleicao_2016 <- eleicoes_1 %>% filter(nome_munic == "Ibaiti" |
                      nome_munic == "Santa Rita Do Passa Quatro" |
                      nome_munic == "Aquiraz" | 
                      nome_munic == "Pedro Osorio" | 
                      nome_munic == "Sao Joao Da Barra" |
                      nome_munic == "Sao Jose Da Barra" |
                      nome_munic == "Morungaba" |
                      nome_munic == "Arceburgo" | 
                      nome_munic == "Vargem Grande Paulista" | 
                      nome_munic == "Campo Belo" |
                      nome_munic == "Cerquilho" |
                      nome_munic == "Pirapora Do Bom Jesus" |
                      nome_munic == "Volta Redonda") %>% 
  select(nome_munic, x2016.y, x2016.x) %>% 
  rename(`Partido do Prefeito que Implementou a Política` = x2016.y, 
         `Ideologia do Partido do Prefeito que Implementou a Política` = x2016.x)

# cidade que a eleição do prefeito que implantou foi em 2020

eleicao_2020 <- eleicoes_1 %>% filter(nome_munic == "Comendador Levy Gasparian" |
                      nome_munic == "Artur Nogueira" |
                      nome_munic == "Itarare" |
                      nome_munic == "Assis" | 
                      nome_munic == "Caete" | 
                      nome_munic == "Caucaia" |
                      nome_munic == "Claudio" |
                      nome_munic == "Costa Rica" |
                      nome_munic == "Formosa" | 
                      nome_munic == "Goias" | 
                      nome_munic == "Itapeva" |
                      nome_munic == "Lagoa Da Prata" |
                      nome_munic == "Santana Do Deserto" |
                      nome_munic == "Sao Joaquim De Bicas" |
                      nome_munic == "Sao Lourenco Da Serra" | 
                      nome_munic == "Tangua" |
                      nome_munic == "Arcos" |
                      nome_munic == "Bombinhas" |
                      nome_munic == "Guararema" |
                      nome_munic == "Mariana" | 
                      nome_munic == "Matinhos" |
                      nome_munic == "Ouro Branco" |
                      nome_munic == "Paranagua" |
                      nome_munic == "Parobe" |
                      nome_munic == "Quatro Barras" |
                      nome_munic == "Rio Branco Do Sul" |
                      nome_munic == "Sao Lourenco" |
                      nome_munic == "Tambau" |
                      nome_munic == "Tiete") %>% 
  select(nome_munic, x2020.y, x2020.x) %>% 
  rename(`Partido do Prefeito que Implementou a Política` = x2020.y, 
         `Ideologia do Partido do Prefeito que Implementou a Política` = x2020.x)


## Juntando as bases 

bind_rows(eleicao_2000, eleicao_2004, eleicao_2008, eleicao_2012, eleicao_2016, eleicao_2020) %>%  arrange(nome_munic) %>% 
  group_by(`Ideologia do Partido do Prefeito que Implementou a Política`) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  select(-n) %>% 
  adorn_pct_formatting(digits = 0) %>% 
  kbl(col.names = c("Ideologia do Partido do Prefeito que Implementou a Política",  "Percentual"), caption = "Tabela 11: Variedade de Espectros Políicos") %>%
  kable_classic(full_width = F , html_font = "Cambria") %>% 
  footnote(general = "",
           general_title = "Fonte: TSE ", number_title = "Type II: ",
           footnote_as_chunk = T, title_format = c("italic"))



```





**4° premissa** Quanto maior a competitividade das eleições anteriores a adoção da política maior a pressão do eleitor mediano por políticas sociais. Se essa premissa for verdadeira, esperamos encontrar menor diferença média na quantidade de votos recebidos pelo prefeito e o candidato em 2° lugar nas eleições anteriores à adoção da política nas cidades com tarifa zero 



```{r}


eleicoes %>% 
  group_by(tarifa_zero) %>% 
  mutate(tarifa_zero = case_when(tarifa_zero == "sim" ~ "sim", 
                                 TRUE ~ "nao")) %>% 
  summarize(mediana = median(diferenca_votos, na.rm  = TRUE)) %>% 
    kbl(col.names = c("A cidade tem tarifa zero?",  "Percentual"), caption = "Tabela 11: Competitividade das Eleições Anteriores a Adoção da Política") %>%
  kable_classic(full_width = F , html_font = "Cambria") %>% 
  footnote(general = "",
           general_title = "Fonte: TSE ", number_title = "Type II: ",
           footnote_as_chunk = T, title_format = c("italic"))

```


```{r}

mediana_diferenca_votos <- eleicoes %>% 
  group_by(tarifa_zero) %>% 
  mutate(tarifa_zero = case_when(tarifa_zero == "sim" ~ "sim", 
                                 TRUE ~ "não")) %>% 
  summarize(diferenca_votos = median(diferenca_votos, na.rm  = TRUE))

eleicoes %>% 
  mutate(tarifa_zero = case_when(tarifa_zero == "sim" ~ "sim", 
                                 TRUE ~ "não")) %>% 
 ggplot() +
 geom_boxplot(aes(x = tarifa_zero, y = diferenca_votos, fill = tarifa_zero), colour="black", alpha = 0.9) + 
 geom_label(data = mediana_diferenca_votos, aes(tarifa_zero, diferenca_votos, label = diferenca_votos), 
              vjust = 0.005, size = 3, 
              colour = "#394B41", fill = "beige", face = "bold") + 
  theme_light() +
  ggtitle("Boxplot das diferenças de votos entre o candidato eleito e segundo colocado") +
  xlab("") +
  ylab("") +
  labs(caption = "Fonte: TSE, 
                  Elaboração Própria") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#c57d4b", "#7e9563"), labels = c("Não", "Sim")) + 
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#579296"),
          plot.caption = element_text(family = "serif", size = 10),
  strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 14),
    axis.text.x=element_blank(),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.position = "bottom")


```

## 2. Teoria das Capacidades Estatais 

**1° premissa:** Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Por isso cidades com tarifa zero devem possuir mais secretarias exclusivas do que cidades sem essa política


```{r}

ffpt_orgao <- banco_completo %>% 
  mutate(caracterizacao_do_orgao_gestor = case_when(caracterizacao_do_orgao_gestor =="Não informou" ~ "Não informou",
                                                      caracterizacao_do_orgao_gestor == "Não possui estrutura" ~ "Secretaria não exclusiva", 
                                                      caracterizacao_do_orgao_gestor == "Recusa" ~ "Não informou",
                                                      caracterizacao_do_orgao_gestor == "Órgão da administração indireta" ~ "Secretaria não exclusiva", 
                                                      caracterizacao_do_orgao_gestor == "Secretaria em conjunto com outras políticas setoriais"  ~ "Secretaria não exclusiva",
                                                      caracterizacao_do_orgao_gestor == "Setor subordinado a outra secretaria" ~ "Secretaria não exclusiva",
                                                      caracterizacao_do_orgao_gestor == "Setor subordinado diretamente à chefia do Executivo"  ~ "Secretaria não exclusiva",
                                                      TRUE~(caracterizacao_do_orgao_gestor))) %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(caracterizacao_do_orgao_gestor) %>% 
  tally() %>% 
  mutate(pct_ffpt = n/sum(n)) %>% 
  select(-2)

banco_completo %>% 
  mutate(caracterizacao_do_orgao_gestor = case_when(caracterizacao_do_orgao_gestor =="Não informou" ~ "Não informou",
                                                      caracterizacao_do_orgao_gestor == "Não possui estrutura" ~ "Secretaria não exclusiva", 
                                                      caracterizacao_do_orgao_gestor == "Recusa" ~ "Não informou",
                                                      caracterizacao_do_orgao_gestor == "Órgão da administração indireta" ~ "Secretaria não exclusiva", 
                                                      caracterizacao_do_orgao_gestor == "Secretaria em conjunto com outras políticas setoriais"  ~ "Secretaria não exclusiva",
                                                      caracterizacao_do_orgao_gestor == "Setor subordinado a outra secretaria" ~ "Secretaria não exclusiva",
                                                      caracterizacao_do_orgao_gestor == "Setor subordinado diretamente à chefia do Executivo"  ~ "Secretaria não exclusiva",
                                                      TRUE~(caracterizacao_do_orgao_gestor))) %>% 
  filter(tarifa_zero == "não") %>% 
  group_by(caracterizacao_do_orgao_gestor) %>% 
  tally() %>% 
  mutate(pct_geral = n/sum(n)) %>% 
  select(-2) %>% 
  left_join(ffpt_orgao, by = "caracterizacao_do_orgao_gestor") %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% 
  adorn_pct_formatting(digits = 0) %>% 
  kbl(col.names = c("Caracterização do orgão gestor", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 11: Caracterização do Orgão Gestor") %>%
  kable_classic(full_width = F , html_font = "Cambria") %>% 
  footnote(general = "IBGE, 2021 ",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )
  
  
```


**2° premissa:**Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Por isso cidades com tarifa zero possuem gestores com mais qualificação acadêmica. 


```{r}

ffpt_escolaridade <- banco_completo %>% 
    filter(escolaridade_do_a_titular_do_orgao_gestor == "Doutorado" |
         escolaridade_do_a_titular_do_orgao_gestor == "Ensino médio (2º Grau) completo"|
         escolaridade_do_a_titular_do_orgao_gestor == "Ensino superior completo"|
         escolaridade_do_a_titular_do_orgao_gestor == "Especialização" | 
         escolaridade_do_a_titular_do_orgao_gestor == "Mestrado") %>% 
  mutate(escolaridade_do_a_titular_do_orgao_gestor = factor(escolaridade_do_a_titular_do_orgao_gestor, levels = c("Ensino médio (2º Grau) completo", 
                                                   "Ensino superior completo", 
                                                   "Especialização", 
                                                   "Mestrado",
                                                   "Doutorado", ordered = TRUE))) %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(escolaridade_do_a_titular_do_orgao_gestor) %>% 
  tally() %>% 
  mutate(pct_ffpt = n/sum(n)) %>% 
  select(-2)

banco_completo %>% 
    filter(escolaridade_do_a_titular_do_orgao_gestor == "Doutorado" |
         escolaridade_do_a_titular_do_orgao_gestor == "Ensino médio (2º Grau) completo"|
         escolaridade_do_a_titular_do_orgao_gestor == "Ensino superior completo"|
         escolaridade_do_a_titular_do_orgao_gestor == "Especialização" | 
         escolaridade_do_a_titular_do_orgao_gestor == "Mestrado") %>% 
  mutate(escolaridade_do_a_titular_do_orgao_gestor = factor(escolaridade_do_a_titular_do_orgao_gestor, levels = c("Ensino médio (2º Grau) completo", 
                                                   "Ensino superior completo", 
                                                   "Especialização", 
                                                   "Mestrado",
                                                   "Doutorado", ordered = TRUE))) %>% 
  filter(tarifa_zero == "não") %>% 
  group_by(escolaridade_do_a_titular_do_orgao_gestor) %>% 
  tally() %>% 
  mutate(pct_escol = n/sum(n)) %>% 
  select(-2) %>% 
  left_join(ffpt_escolaridade, by = "escolaridade_do_a_titular_do_orgao_gestor") %>% 
  adorn_pct_formatting(digits = 0) %>% 
mutate(pct_ffpt = gsub(pattern = "-",replacement = "0%", pct_ffpt)) %>% 
kbl(col.names = c("Escolaridade", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 12: Escolaridade do Titular do Orgão Gestor") %>%
kable_classic(full_width = F , html_font = "Cambria") %>% 
footnote(general = "IBGE, 2021 ",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )
  

```


**3° premissa:** Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Por isso cidades com tarifa zero dispõem de maior quantidade de conselhos de transporte público em relação à cidades sem a política 


```{r}

ffpt_conselho <- banco_completo %>% 
       mutate(conselho_municipal_de_transporte_existencia =case_when(conselho_municipal_de_transporte_existencia =="Não" ~"Não ou não informou",
                                                       conselho_municipal_de_transporte_existencia == "Não informou" ~ "Não ou não informou", 
                                                       conselho_municipal_de_transporte_existencia == "Recusa" ~ "Não ou não informou",
                                                       TRUE~(conselho_municipal_de_transporte_existencia))) %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(conselho_municipal_de_transporte_existencia) %>% 
  tally() %>% 
  mutate(pct_ffpt = n/sum(n)) %>% 
  select(-2)

banco_completo %>% 
         mutate(conselho_municipal_de_transporte_existencia =case_when(conselho_municipal_de_transporte_existencia =="Não" ~"Não ou não informou",
                                                       conselho_municipal_de_transporte_existencia == "Não informou" ~ "Não ou não informou", 
                                                       conselho_municipal_de_transporte_existencia == "Recusa" ~ "Não ou não informou",
                                                       TRUE~(conselho_municipal_de_transporte_existencia))) %>% 
  filter(tarifa_zero == "não") %>% 
  group_by(conselho_municipal_de_transporte_existencia) %>% 
  tally() %>% 
  mutate(pct_conselho = n/sum(n)) %>% 
  select(-2) %>% 
  left_join(ffpt_conselho, by = "conselho_municipal_de_transporte_existencia") %>% 
  adorn_pct_formatting(digits = 0) %>% 
kbl(col.names = c("Existe Conselho na Cidade?", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 13: Existência de Conselho Municipal de Transporte") %>%
kable_classic(full_width = F , html_font = "Cambria") %>% 
footnote(general = "IBGE, 2021 ",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )
  

```

**4° premissa:** Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Por isso cidades com tarifa zero dispõem de Fundo Municipal de Transporte em relação à cidades sem a política 

```{r}

ffpt_fundo <- banco_completo %>% 
  mutate(fundo_municipal_de_transporte_existencia = case_when(fundo_municipal_de_transporte_existencia =="Não" ~"Não ou não informou",
                                                      fundo_municipal_de_transporte_existencia == "Não informou" ~ "Não ou não informou", 
                                                      fundo_municipal_de_transporte_existencia == "Recusa" ~ "Não ou não informou",
                                                       TRUE~(fundo_municipal_de_transporte_existencia))) %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(fundo_municipal_de_transporte_existencia) %>% 
  tally() %>% 
  mutate(pct_ffpt = n/sum(n)) %>% 
  select(-2)

banco_completo %>%
  mutate(fundo_municipal_de_transporte_existencia = case_when(fundo_municipal_de_transporte_existencia =="Não" ~"Não ou não informou",
                                                       fundo_municipal_de_transporte_existencia == "Não informou" ~ "Não ou não informou", 
                                                       fundo_municipal_de_transporte_existencia == "Recusa" ~ "Não ou não informou",
                                                       TRUE~(fundo_municipal_de_transporte_existencia))) %>% 
  filter(tarifa_zero == "não") %>% 
  group_by(fundo_municipal_de_transporte_existencia) %>% 
  tally() %>% 
  mutate(pct_conselho = n/sum(n)) %>% 
  select(-2) %>% 
  left_join(ffpt_fundo, by = "fundo_municipal_de_transporte_existencia") %>% 
  adorn_pct_formatting(digits = 0) %>% 
kbl(col.names = c("Existe Fundo Municipal?", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 14: Existência de Fundo Municipal de Transporte") %>%
kable_classic(full_width = F, html_font = "Cambria") %>% 
footnote(general = "IBGE, 2021 ",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )
  

```


**5° premissa:** Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Por isso cidades com tarifa zero dispõem de Plano de Mobilidade Urbana em mais cidades do que em relação à cidades sem a política 


```{r}


ffpt_plano <- banco_completo %>% 
     mutate(possui_plano_de_mobilidade_urbana =case_when(possui_plano_de_mobilidade_urbana =="SIM" ~"Sim",
                                                       possui_plano_de_mobilidade_urbana == "Nao foi enviado oficio" ~ "Não ou não respondeu", 
                                                       possui_plano_de_mobilidade_urbana == "Nao respondeu" ~ "Não ou não respondeu",
                                                       possui_plano_de_mobilidade_urbana == "Nao" ~ "Não ou não respondeu",
                                                       TRUE~(possui_plano_de_mobilidade_urbana))) %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(possui_plano_de_mobilidade_urbana) %>% 
  tally() %>% 
  mutate(pct_ffpt = n/sum(n)) %>% 
  select(-2)

banco_completo %>% 
     mutate(possui_plano_de_mobilidade_urbana =case_when(possui_plano_de_mobilidade_urbana =="SIM" ~"Sim",
                                                       possui_plano_de_mobilidade_urbana == "Nao foi enviado oficio" ~ "Não ou não respondeu", 
                                                       possui_plano_de_mobilidade_urbana == "Nao respondeu" ~ "Não ou não respondeu",
                                                       possui_plano_de_mobilidade_urbana == "Nao" ~ "Não ou não respondeu",
                                                       TRUE~(possui_plano_de_mobilidade_urbana))) %>% 
  filter(tarifa_zero == "não") %>% 
  group_by(possui_plano_de_mobilidade_urbana) %>% 
  tally() %>% 
  mutate(pct_conselho = n/sum(n)) %>% 
  select(-2) %>% 
  left_join(ffpt_plano, by = "possui_plano_de_mobilidade_urbana") %>% 
  adorn_pct_formatting(digits = 0) %>% 
kbl(col.names = c("Existe Plano de Mobilidade Urbana?", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 15: Existência de Plano de Mobilidade Urbana") %>%
kable_classic(full_width = F, html_font = "Cambria") %>% 
footnote(general = "IBGE, 2021 ",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )
  

```


**6° premissa:** Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Por isso cidades com tarifa zero dispõem de maior "Prosperidade Social" indicador definido pelo IPEA

```{r}


  ffpt_ps <- banco_completo %>% 
  mutate(prosperidade_social = factor(prosperidade_social, levels = c("Muito Alto", 
                                                   "Alto", 
                                                   "Baixo", 
                                                   "Muito Baixo",
                                                   "Médio", ordered = TRUE))) %>%
  filter(tarifa_zero == "sim") %>% 
  group_by(prosperidade_social) %>% 
  tally() %>% 
  mutate(pct_ffpt = n/sum(n)) %>% 
  select(-2)

banco_completo %>% 
  mutate(prosperidade_social = factor(prosperidade_social, levels = c("Muito Alto", 
                                                   "Alto", 
                                                   "Baixo", 
                                                   "Muito Baixo",
                                                   "Médio", ordered = TRUE))) %>%
  filter(tarifa_zero == "não") %>% 
  group_by(prosperidade_social) %>% 
  tally() %>% 
  mutate(pct_geral = n/sum(n)) %>% 
  select(-2) %>% 
  left_join(ffpt_ps, by = "prosperidade_social") %>% 
  adorn_pct_formatting(digits = 0) %>% 
  mutate(pct_ffpt = gsub(pattern = "-",replacement = "0%", pct_ffpt)) %>% 
kbl(col.names = c("Índice de Prosperidade Social", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 16: Índice de Prosperidade Social") %>%
kable_classic(full_width = F, html_font = "Cambria") %>% 
footnote(general = "IPEA, 2010",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )


```

**7° premissa:** Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Verificar a quantidade de funcionários estatutários dos municípios da administração direta - Carreira estável e recrutamento baseado no mérito produz capacidade estatal para adoção de políticas urbanas


```{r}

recursos_humanos_ffpt <- 
banco_completo %>% 
mutate(Estatutarios = as.double(Estatutarios), Celetistas = as.double(Celetistas), Estagiarios = as.double(Estagiarios), `Sem vinculo Permanente` = as.double(sem_vinculo_permanente)) %>% 
pivot_longer(cols = c("Estatutarios", "Celetistas", "Comissionados", "Estagiarios", "Sem vinculo Permanente")) %>% 
group_by(tarifa_zero, name) %>% 
summarise(media_ffpt = median(value, na.rm = TRUE)) %>% 
filter(tarifa_zero == "sim") %>% 
ungroup() %>% 
select(-tarifa_zero)


banco_completo %>% 
mutate(Estatutarios = as.double(Estatutarios), Celetistas = as.double(Celetistas), Estagiarios = as.double(Estagiarios), `Sem vinculo Permanente` = as.double(sem_vinculo_permanente)) %>% 
pivot_longer(cols = c("Estatutarios", "Celetistas", "Comissionados", "Estagiarios", "Sem vinculo Permanente")) %>% 
group_by(tarifa_zero, name) %>% 
summarise(media_geral = median(value, na.rm = TRUE)) %>% 
filter(tarifa_zero == "não") %>% 
ungroup() %>% 
left_join(recursos_humanos_ffpt, by = "name") %>% 
select(-tarifa_zero) %>% 
kbl(col.names = c("Regime de Contratação", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 17: Regime de Contratação dos Funcionários da Administração Direta") %>%
kable_classic(full_width = F , html_font = "Times New Roman") %>% 
footnote(general = "IBGE, 2021 ",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )



```


## 3.Análise da Difusão de Políticas Publicas 

**1° premissa:**Verificar o padrão de difusão nas cidades que se sabe o ano da implementação - Políticas sociais primeiro se espalham na região onde surgiram e depois vão se difundindo para outras partes do país. Dessa forma, esperamos encontrar um padrão de difusão. 


```{r}

banco_completo %>% 
  mutate(ano_implementacao_classe = factor(ano_implementacao_classe, levels = c("Anos 90", 
                                                                          "Entre 2001 e 2009", 
                                                                          "Entre 2010 e 2015", 
                                                                          "Entre 2016 e 2020",
                                                                          "Entre 2021 e 2022", ordered = T))) %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(ano_implementacao_classe, regiao) %>% 
  tally() %>% 
    ggplot() + 
  geom_col(aes(x = ano_implementacao_classe, y = n, fill = regiao), color = "darkgray") + 
   theme_light() +
  ggtitle("Padrão de difusão da Tarifa Zero entre as regiões brasileiras") +
  xlab("") +
  ylab("") +
  labs(caption = "Elaboração Própria") +
  scale_fill_manual(name = "Região:", values = c("#4b895a", "#b16673", "#4e8397", "#c57d4b"), labels = c("Centro-Oeste", "Nordeste", "Sudeste", "Sul")) + 
  theme_light() + 
  geom_text(aes(x = ano_implementacao_classe, y =n, label = n, group = regiao), size = 3, position = position_stack(vjust = 0.3)) +
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#579296"),
          plot.caption = element_text(family = "serif", size = 10),
  strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 14),
    axis.text.y= element_blank(),
    legend.position = "bottom")



```



**2° premissa:** Verificar se as cidades que implementaram primeiro são maiores do que aquelas que adotaram depois, dessa forma pode-se observar se houve imitação de cidades menores em relação às maiores


```{r include=FALSE}

regiao_nordeste <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  select(regiao, ano_implementacao, populacao) %>% 
  group_by(ano_implementacao, regiao, populacao) %>% 
  arrange(regiao) %>% 
  mutate(ano_implementacao = as.character(ano_implementacao)) %>% 
  ungroup() %>% 
  filter(regiao == " Nordeste") %>% 
  ggplot() + 
  geom_point(aes(x = ano_implementacao, y = populacao), color = "#579296", size = 4) + 
  geom_text_repel(aes(x = ano_implementacao, y = populacao, label = scales::dollar(prefix = " ", round(populacao, 1))), size = 3, hjust = 0.5, vjust = 1.5,point.padding = 0.5) +   
   theme_light() +
  ggtitle("Tamanho da população e ano de implementação de cada cidade 
          Região: Nordeste") +
  xlab("") +
  ylab("") +
  labs(caption = "Fonte: Censo IBGE, 2022
                 Elaboração Própria") +
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#579296"),
          plot.caption = element_text(family = "serif", size = 10),
  strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 14),
    axis.text.y=element_blank(),
    axis.text.x=element_text(size = 11, family = "serif"),
    legend.position = "bottom")
  

  


```


```{r include=FALSE}

regiao_centro_oeste <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  select(regiao, ano_implementacao, populacao) %>% 
  group_by(ano_implementacao, regiao, populacao) %>% 
  arrange(regiao) %>% 
  mutate(ano_implementacao = as.character(ano_implementacao)) %>% 
  ungroup() %>% 
  filter(regiao == " Centro-Oeste") %>% 
  ggplot() + 
  geom_point(aes(x = ano_implementacao, y = populacao), color = "#579296", size = 4) + 
  geom_text_repel(aes(x = ano_implementacao, y = populacao, label = scales::dollar(prefix = " ", round(populacao, 1))), size = 3, hjust = 0.5, vjust = 1.5,point.padding = 0.5) +
  theme_light() +
  ggtitle("Região: Centro-Oeste") +
  xlab("") +
  ylab("") +
  ggtitle("Tamanho da população e ano de implementação de cada cidade 
          Região: Centro-Oeste") +
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#579296"),
          plot.caption = element_text(family = "serif", size = 10),
  strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 14),
    axis.text.y=element_blank(),
    axis.text.x=element_text(size = 11, family = "serif"),
    legend.position = "bottom")
  


```

```{r}


banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  select(regiao, ano_implementacao, populacao) %>% 
  group_by(ano_implementacao, regiao, populacao) %>% 
  arrange(regiao) %>% 
  mutate(ano_implementacao = as.character(ano_implementacao)) %>% 
  ungroup() %>% 
  filter(regiao == " Sul") %>% 
  ggplot() + 
  geom_point(aes(x = ano_implementacao, y = populacao), color = "#579296", size = 4) + 
  geom_text_repel(aes(x = ano_implementacao, y = populacao, label = scales::dollar(prefix = " ", round(populacao, 1))), size = 3, hjust = 0.5, vjust = 1.5,point.padding = 0.5) +
   theme_light() +
  ggtitle("Tamanho da população e ano de implementação de cada cidade 
          Região: Sul") +
  xlab("") +
  ylab("") +
   labs(caption = "Fonte: Censo IBGE, 2022 
                   Elaboração Própria") +
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#579296"),
          plot.caption = element_text(family = "serif", size = 10),
  strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 14),
    axis.text.y=element_blank(),
    axis.text.x=element_text(size = 11, family = "serif"),
    legend.position = "bottom")



```

```{r}

regiao_sudeste <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  select(regiao, ano_implementacao, populacao) %>% 
  group_by(ano_implementacao, regiao, populacao) %>% 
  arrange(regiao) %>% 
  mutate(ano_implementacao = as.character(ano_implementacao)) %>% 
  ungroup() %>% 
  filter(regiao == " Sudeste") %>% 
  ggplot() + 
  geom_point(aes(x = ano_implementacao, y = populacao, size = populacao), color = "#579296", alpha = 0.7) + 
  # geom_text_repel(aes(x = ano_implementacao, y = populacao, label = scales::dollar(prefix = " ", round(populacao, 1))), size = 3, hjust = 0.5, vjust = 1.5,point.padding = 0.5) + 
   theme_light() +
  ggtitle("Tamanho da população e ano de implementação de cada cidade 
          Região: Sudeste") + 
  xlab("") +
  ylab("") +
  labs(caption = "Fonte: Censo IBGE, 2022
                  Elaboração Própria") +
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#579296"),
          plot.caption = element_text(family = "serif", size = 10),
  strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 14),
    axis.text.x=element_text(size = 10, family = "serif"),
    legend.position = "botton") +
   scale_y_continuous(labels = function(x) format(x, big.mark = "."))
regiao_sudeste

```



```{r eval=FALSE, include=FALSE}


oeste_nordeste <- ggarrange(regiao_centro_oeste, regiao_nordeste, 
                                 ncol = 1, nrow = 2)

oeste_nordeste

```


Todas as cidades brasileiras: 

```{r }


options(scipen = 999)

  banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  select(regiao, ano_implementacao, populacao) %>% 
  group_by(ano_implementacao, regiao, populacao) %>% 
  arrange(regiao) %>% 
  mutate(ano_implementacao = as.character(ano_implementacao)) %>% 
  ungroup() %>% 
  rename(`Região:` = regiao) %>% 
  ggplot() + 
  geom_point(aes(x = ano_implementacao, y = populacao, color = `Região:`), alpha = 0.5, size = 5) + 
 theme_light() +
  ggtitle("Tamanho da população e ano de implementação de cada cidade 
          Todas as Regiões") +
  xlab("") +
  ylab("") +
  labs(caption = "Fonte: Censo IBGE, 2022 
                 Elaboração Própria") +
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#579296"),
          plot.caption = element_text(family = "serif", size = 10),
  strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 12),
    axis.text.x=element_text(size = 9, family = "serif"),
    legend.position = "top") + 
    scale_y_continuous(labels = function(x) format(x, big.mark = "."))


```


## 2. Teoria dos Multilplos Fluxos 

**1° premissa:**Verificar a proximidade temporal entre debate nacional (Jornadas de Junho de 2013 e Pandemia de Covid-19) e adoção da tarifa zero pelos municípios e se nas entrevistas esses eventos são citados - Humor nacional - fluxo das soluções.


```{r}

file1 <- "https://raw.githubusercontent.com/thais01fernandes/mestrado_usp/main/dados/banco_completo"
banco_completo_1 <- read_delim(file1, delim = ",", 
                        locale = locale(encoding='UTF-8')) %>% select(-1)

banco_completo_1 %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(ano_implementacao) %>% 
  tally() %>% 
  arrange(n) %>% 
  mutate(ano_protestos = 2013) %>% 
  ggplot() + 
  geom_point(aes(x = ano_implementacao, y = n, size = n), color = "#c57d4b", alpha = 0.7) + 
  geom_vline(xintercept = 2013) + 
  geom_vline(xintercept = 2020) + 
  scale_y_continuous(breaks = c(2, 4, 6, 8, 10, 12, 14)) +
  geom_text_repel(aes(x = ano_implementacao, y = n, label = ano_implementacao), size = 3, hjust = 0.5, vjust = 1.5,point.padding = 0.5) + 
   theme_light() +
  ggtitle("Proximidade entre Jornadas de Junho de 2013, Pandemia de Covid-19 e adoção da Tarifa Zero") +
  xlab("") +
  ylab("") +
  theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
  plot.caption = element_text(family = "serif", size = 10),
  strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 14),
    axis.text.x=element_blank(),
    axis.text.y=element_text(size = 11, family = "serif"),
    legend.position = "none") +
    labs(caption = "Fonte: Levantamento Colabarativo, 2022 
                     Elaboração Própria") +
  annotate("label", x=2013, y=11, label="Jornadas de Junho de 2013",
  color="black", size=3) + 
  annotate(
  "label", x=2020, y=11, label="Pandemia de Covid-19",
  color="black", size=3)


```

**2° premissa:**Verificar se houve uma mudança partidária nas eleições para prefeito anterior a adoção da política, e nas cidades em que houve essa mudança verificar se houve também mudança de expectro ideológico do partido - Mudanças no governo propiciam a adoção de novas políticas públicas


```{r}

# Criar tabelas com cidades de acordo com o ano da eleição anterior a adoção da Política: 

# Cidades que implementaram em 2000 não será possível verificar pois não se obteve os dados das eleições de 1996 no site do TSE, o banco está incompleto :/

# cidade que a eleição do prefeito que implantou foi em 2004

eleicao_2004 <- eleicoes_1 %>% filter(nome_munic == "Aruana"|
                                      nome_munic == "Holambra") %>% 
  select(nome_munic, x2000.y, x2004.y, x2000.x, x2004.x) %>% 
  rename(`Partido do Prefeito Anterior` = x2000.y, `Partido do Prefeito que Implementou a Política` = x2004.y,
         `Ideologia do Partido do Prefeito Anterior` = x2000.x, `Ideologia do Partido do Prefeito que Implementou a Política` = x2004.x)

# cidade que a eleição do prefeito que implantou foi em 2008

eleicao_2008 <- eleicoes_1 %>% filter(nome_munic == "Wenceslau Braz" |
                      nome_munic == "Holambra" |
                      nome_munic == "Presidente Kennedy"|
                      nome_munic == "Euzebio" | 
                      nome_munic == "Muzambinho" | 
                      nome_munic == "Pitanga" |
                      nome_munic == "Ilha Solteira") %>% 
  select(nome_munic, x2004.y, x2008.y, x2004.x, x2008.x) %>% 
  rename(`Partido do Prefeito Anterior` =  x2004.y, `Partido do Prefeito que Implementou a Política` = x2008.y, 
         `Ideologia do Partido do Prefeito Anterior` = x2004.x, `Ideologia do Partido do Prefeito que Implementou a Política` = x2008.x)

# cidade que a eleição do prefeito que implantou foi em 2012

eleicao_2012 <- eleicoes_1 %>% filter(
                      nome_munic == "Silva Jardim" |
                      nome_munic == "Dourado" | 
                      nome_munic == "Marica" | 
                      nome_munic == "Anicuns" |
                      nome_munic == "Itatiaiucu") %>% 
  select(nome_munic, x2008.y, x2012.y, x2008.x, x2012.x) %>% 
  rename(`Partido do Prefeito Anterior` = x2008.y, `Partido do Prefeito que Implementou a Política` = x2012.y, 
         `Ideologia do Partido do Prefeito Anterior` = x2008.x, `Ideologia do Partido do Prefeito que Implementou a Política` = x2012.x)

# cidade que a eleição do prefeito que implantou foi em 2016

eleicao_2016 <- eleicoes_1 %>% filter(nome_munic == "Ibaiti" |
                      nome_munic == "Volta Redonda" |
                      nome_munic == "Santa Rita Do Passa Quatro" |
                      nome_munic == "Aquiraz" | 
                      nome_munic == "Pedro Osorio" | 
                      nome_munic == "Sao Joao Da Barra" |
                      nome_munic == "Sao Jose Da Barra" |
                      nome_munic == "Morungaba" |
                      nome_munic == "Arceburgo" | 
                      nome_munic == "Vargem Grande Paulista" | 
                      nome_munic == "Campo Belo" |
                      nome_munic == "Cerquilho" |
                      nome_munic == "Pirapora Do Bom Jesus" |
                      nome_munic == "Volta Redonda") %>% 
  select(nome_munic, x2012.y, x2016.y, x2012.x, x2016.x) %>% 
  rename(`Partido do Prefeito Anterior` = x2012.y, `Partido do Prefeito que Implementou a Política` = x2016.y, 
         `Ideologia do Partido do Prefeito Anterior` = x2012.x, `Ideologia do Partido do Prefeito que Implementou a Política` = x2016.x)

# cidade que a eleição do prefeito que implantou foi em 2020

eleicao_2020 <- eleicoes_1 %>% filter(nome_munic == "Comendador Levy Gasparian" |
                      nome_munic == "Artur Nogueira" |
                      nome_munic == "Assis" | 
                      nome_munic == "Itarare"
                      nome_munic == "Caete" | 
                      nome_munic == "Caucaia" |
                      nome_munic == "Claudio" |
                      nome_munic == "Costa Rica" |
                      nome_munic == "Formosa" | 
                      nome_munic == "Goias" | 
                      nome_munic == "Itapeva" |
                      nome_munic == "Lagoa Da Prata" |
                      nome_munic == "Santana Do Deserto" |
                      nome_munic == "Sao Joaquim De Bicas" |
                      nome_munic == "Sao Lourenco Da Serra" | 
                      nome_munic == "Tangua" |
                      nome_munic == "Arcos" |
                      nome_munic == "Bombinhas" |
                      nome_munic == "Guararema" |
                      nome_munic == "Mariana" | 
                      nome_munic == "Matinhos" |
                      nome_munic == "Ouro Branco" |
                      nome_munic == "Paranagua" |
                      nome_munic == "Parobe" |
                      nome_munic == "Quatro Barras" |
                      nome_munic == "Rio Branco Do Sul" |
                      nome_munic == "Sao Lourenco" |
                      nome_munic == "Tambau" |
                      nome_munic == "Tiete") %>% 
  select(nome_munic, x2016.y, x2020.y, x2016.x, x2020.x) %>% 
  rename(`Partido do Prefeito Anterior` = x2016.y, `Partido do Prefeito que Implementou a Política` = x2020.y, 
         `Ideologia do Partido do Prefeito Anterior` = x2016.x, `Ideologia do Partido do Prefeito que Implementou a Política` = x2020.x)



mudanca_partidaria <- bind_rows(eleicao_2004, eleicao_2008, eleicao_2012, eleicao_2016, eleicao_2020) %>%
  select(nome_munic, `Partido do Prefeito Anterior`, `Partido do Prefeito que Implementou a Política`) %>% 
  mutate(`Houve mudança Partidária?` = ifelse(`Partido do Prefeito Anterior` == `Partido do Prefeito que Implementou a Política`, "Não", "Sim")) %>% 
  arrange(`Houve mudança Partidária?`)

houve_mudança_partidaria <- mudanca_partidaria %>% 
  filter(`Houve mudança Partidária?`== "Sim")

mudanca_ideologica <- bind_rows(eleicao_2004, eleicao_2008, eleicao_2012, eleicao_2016, eleicao_2020) %>%
  inner_join(houve_mudança_partidaria, by = "nome_munic") %>% 
  select(nome_munic, `Ideologia do Partido do Prefeito Anterior`, `Ideologia do Partido do Prefeito que Implementou a Política`) %>% 
  mutate(`Houve mudança ideológica?` = ifelse(`Ideologia do Partido do Prefeito Anterior` == `Ideologia do Partido do Prefeito que Implementou a Política`, "Não", "Sim")) %>% 
  arrange(`Houve mudança ideológica?`)
  

```
 
 
```{r}

mudanca_partidaria %>% 
  reactable(fullWidth = FALSE,
      defaultPageSize = 7,
      searchable = TRUE,
      outlined = FALSE, 
      showPageInfo = TRUE, 
      showPageSizeOptions = TRUE,
      defaultColDef = colDef(
      align = "center",
        headerStyle = list(background = "#E3B485")),
      columns = list(
      nome_munic = colDef("Nome do Município", minWidth = 100, align = "center"),
      `Partido do Prefeito Anterior` = colDef("Partido do Prefeito Anterior", minWidth = 80, align = "center"),
      `Partido do Prefeito que Implementou a Política` = colDef("Partido do Prefeito que Implementou a Política",  minWidth = 80, align = "center"),
      `Houve mudança Partidária?` = colDef("Houve mudança Partidária?",  minWidth = 70, align = "center"),
       pageSizeOptions = c(5,10,15,20,25,30), bordered = TRUE, striped = FALSE, highlight = TRUE))


```
 
 Tabela Resumindo se houve mudança partidária

```{r}


mudanca_partidaria %>% 
  group_by(`Houve mudança Partidária?`) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  select(-n) %>% 
  adorn_pct_formatting(digits = 0) %>%
  kbl(col.names = c("Houve mudança Partidária?", "Total Percentual"), caption = "Tabela 18: Mudança Partidária nos municípios que adotaram tarifa zero") %>%
kable_classic(full_width = F , html_font = "Times New Roman") %>% 
footnote(general = "TSE",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )
  

```

Para as Cidades em que houve mudança partidária, houve mudança ideológica? 

```{r}

mudanca_ideologica %>% 
  reactable(fullWidth = FALSE,
      defaultPageSize = 7,
      searchable = TRUE,
      outlined = FALSE, 
      showPageInfo = TRUE, 
      showPageSizeOptions = TRUE,
      defaultColDef = colDef(
      align = "center",
        headerStyle = list(background = "#E3B485")),
      columns = list(
      nome_munic = colDef("Nome do Município", minWidth = 100, align = "center"),
      `Ideologia do Partido do Prefeito Anterior` = colDef("Partido do Prefeito Anterior", minWidth = 80, align = "center"),
      `Ideologia do Partido do Prefeito que Implementou a Política` = colDef("Partido do Prefeito que Implementou a Política",  minWidth = 80, align = "center"),
      `Houve mudança ideológica?` = colDef("Houve mudança Ideológica?",  minWidth = 70, align = "center"),
       pageSizeOptions = c(5,10,15,20,25,30), bordered = TRUE, striped = FALSE, highlight = TRUE))



```


```{r}

mudanca_ideologica %>% 
  group_by(`Houve mudança ideológica?`) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  select(-n) %>% 
  adorn_pct_formatting(digits = 0) %>%
  kbl(col.names = c("Houve mudança Ideológica?", "Total Percentual"), caption = "Tabela 18: Mudança Ideológica nos municípios em que houve mudança partidária") %>%
kable_classic(full_width = F , html_font = "Times New Roman") %>% 
footnote(general = "TSE",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )


```


Das cidades que mudaram de partido e de espectro político, qual a proporção de cada direcionamento político? 


```{r}


dados_1 <- mudanca_ideologica %>% 
  filter(`Houve mudança ideológica?` == "Sim") %>% 
  group_by(`Ideologia do Partido do Prefeito Anterior`) %>% 
  tally() %>% 
  mutate(pct_anterior = n/sum(n)) %>% 
  select(-n) %>% 
  ungroup() %>% 
  rename(`Espectro Político` = `Ideologia do Partido do Prefeito Anterior`) 

dados_2 <- mudanca_ideologica %>% 
  group_by(`Ideologia do Partido do Prefeito que Implementou a Política`) %>% 
  tally() %>% 
  mutate(pct_implementou = n/sum(n)) %>% 
  select(-n)%>% 
  ungroup() %>% 
  rename(`Espectro Político` = `Ideologia do Partido do Prefeito que Implementou a Política`) 
 

dados_1 %>% left_join(dados_2, by = c("Espectro Político")) %>% 
    mutate(`Espectro Político` = factor(`Espectro Político`, levels = c("Direita", 
                                                    "Extrema Direita", 
                                                    "Centro Direita",
                                                    "Centro",
                                                    "Centro Esquerda", 
                                                    "Esquerda", 
                                                     ordered = TRUE))) %>% 
  adorn_pct_formatting(digits = 0) %>%
  kbl(col.names = c("Espectro Ideológico", "Percentual Governo Anterior", "Percentual Governo que Implementou"), caption = "Tabela 19: Mudança Ideológica nos municípios em que houve mudança partidária") %>%
kable_classic(full_width = F , html_font = "Times New Roman") %>% 
footnote(general = "TSE",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic"))


```


Das cidades que mudaram de partido e de espectro político, govern mudou a proporção de cada espectro político dentro do governo? 



```{r}



mudanca_ideologica %>% 
  filter(`Houve mudança ideológica?` == "Sim") %>% 
  pivot_longer(cols = c("Ideologia do Partido do Prefeito Anterior", "Ideologia do Partido do Prefeito que Implementou a Política")) %>% 
  group_by(name, value) %>% 
  tally() %>% 
  ungroup() %>% 
  group_by(value) %>% 
  mutate(pct = n/sum(n)) %>% 
  ungroup() %>% 
  mutate(value = factor(value, levels = c("Centro Esquerda", 
                                          "Direita", 
                                                    "Esquerda", 
                                                    "Centro Direita",
                                                    "Extrema Direita",
                                                    "Centro", 
                                                     ordered = TRUE))) %>%
  ggplot() + 
  geom_col(aes(x = value, y = pct, fill = name)) + 
  theme_minimal() + 
  xlab("") +
  ylab("") +
  ggtitle("Das cidades que mudaram de partido e de espectro político, como mudou a proporção de cada 
           espectro político dentro do governo?") +
  geom_label(aes(x = value, y = pct, group = name, label = scales::percent(pct, accuracy = 2)), 
             position = position_fill(), family = "serif", size = 4, colour = "black", fill = "Beige", vjust  = 2) +
   labs(caption = "Fonte: TSE, 
                   Elaboração Própria") +
  scale_fill_manual(name = "", values = c("#c57d4b", "#7e9563"), labels = c("Partido do Prefeito Anterior", "Partido do Prefeito que Implementou a Política")) + 
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          text = element_text(family = "serif", size = 12),
    axis.text.y=element_blank(),
    axis.text.x=element_text(size = 11, family = "serif"),
    legend.position = "bottom")



  


```


## 3.Análise da Teoria da Política Partidária

**1° premissa:**Partidos de esquerda adotam mais políticas redistributivas e aumentam o gasto público. Se essa premissa for verdadeira e nos ajuda a explicar a adoção da tarifa zero, uma quantidade relevante de cidades terão implementado a política com governos de esquerda e centro esquerda no poder. 

Análise para os dados de ideologia partidária após o resultado das eleições municipais de 2020


```{r}

tf <- eleicoes_2 %>% 
  filter(ANO_ELEICAO == 2020 & tarifa_zero == "sim") %>% 
  group_by(ideologia_dos_partidos) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  rename(`cidades com tarifa zero` = pct) %>% 
  select(-n) %>% 
  adorn_pct_formatting(digits = 0) 

eleicoes_2 %>% 
  filter(ANO_ELEICAO == 2020 & tarifa_zero == "não") %>% 
  group_by(ideologia_dos_partidos) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  rename(`cidades sem tarifa zero` = pct) %>% 
  select(-n) %>% 
  adorn_pct_formatting(digits = 1) %>% 
  left_join(tf, by = "ideologia_dos_partidos")
  



```

Análise para os dados de ideologia partidária após o resultado das eleições municipais de 2016

```{r}

tf <- eleicoes_2 %>% 
  filter(ANO_ELEICAO == 2016 & tarifa_zero == "sim") %>% 
  group_by(ideologia_dos_partidos) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  rename(`cidades com tarifa zero` = pct) %>% 
  select(-n) %>% 
  adorn_pct_formatting(digits = 1) 

eleicoes_2 %>% 
  filter(ANO_ELEICAO == 2016 & tarifa_zero == "não") %>% 
  group_by(ideologia_dos_partidos) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  rename(`cidades sem tarifa zero` = pct) %>% 
  select(-n) %>% 
  adorn_pct_formatting(digits = 1) %>% 
  left_join(tf, by = "ideologia_dos_partidos")
  



```

Dados Agregados 2016 

```{r}

tf <- eleicoes_2 %>% 
  filter(ANO_ELEICAO == 2016 & tarifa_zero == "sim") %>% 
  mutate(dado_agregado = case_when(ideologia_dos_partidos == "Direita" ~ "Direita", 
                                   ideologia_dos_partidos == "Centro Direita" ~ "Direita", 
                                   ideologia_dos_partidos == "Extrema Direita" ~ "Direita", 
                                   ideologia_dos_partidos == "Esquerda" ~ "Esquerda", 
                                   ideologia_dos_partidos == "Centro Esquerda" ~ "Esquerda", 
                                   ideologia_dos_partidos == "Extrema Esquerda" ~ "Esquerda", 
                                   ideologia_dos_partidos == "Centro" ~ "Centro", TRUE ~ ideologia_dos_partidos)) %>%   
  group_by(dado_agregado) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  rename(`cidades com tarifa zero` = pct) %>% 
  select(-n) %>% 
  adorn_pct_formatting(digits = 1) 
  
eleicoes_2 %>% 
  filter(ANO_ELEICAO == 2016 & tarifa_zero == "não") %>% 
  mutate(dado_agregado = case_when(ideologia_dos_partidos == "Direita" ~ "Direita", 
                                   ideologia_dos_partidos == "Centro Direita" ~ "Direita", 
                                   ideologia_dos_partidos == "Extrema Direita" ~ "Direita", 
                                   ideologia_dos_partidos == "Esquerda" ~ "Esquerda", 
                                   ideologia_dos_partidos == "Centro Esquerda" ~ "Esquerda", 
                                   ideologia_dos_partidos == "Extrema Esquerda" ~ "Esquerda", 
                                   ideologia_dos_partidos == "Centro" ~ "Centro", TRUE ~ ideologia_dos_partidos)) %>%  
  group_by(dado_agregado) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  rename(`cidades sem tarifa zero` = pct) %>% 
  select(-n) %>% 
  adorn_pct_formatting(digits = 1) %>% 
  left_join(tf, by = "dado_agregado")

```

Dados Agregados 2020

```{r}

tf <- eleicoes_2 %>% 
  filter(ANO_ELEICAO == 2020 & tarifa_zero == "sim") %>% 
  mutate(dado_agregado = case_when(ideologia_dos_partidos == "Direita" ~ "Direita", 
                                   ideologia_dos_partidos == "Centro Direita" ~ "Direita", 
                                   ideologia_dos_partidos == "Extrema Direita" ~ "Direita", 
                                   ideologia_dos_partidos == "Esquerda" ~ "Esquerda", 
                                   ideologia_dos_partidos == "Centro Esquerda" ~ "Esquerda", 
                                   ideologia_dos_partidos == "Extrema Esquerda" ~ "Esquerda", 
                                   ideologia_dos_partidos == "Centro" ~ "Centro", TRUE ~ ideologia_dos_partidos)) %>%   
  group_by(dado_agregado) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  rename(`cidades com tarifa zero` = pct) %>% 
  select(-n) %>% 
  adorn_pct_formatting(digits = 1) 
  
eleicoes_2 %>% 
  filter(ANO_ELEICAO == 2020 & tarifa_zero == "não") %>% 
  mutate(dado_agregado = case_when(ideologia_dos_partidos == "Direita" ~ "Direita", 
                                   ideologia_dos_partidos == "Centro Direita" ~ "Direita", 
                                   ideologia_dos_partidos == "Extrema Direita" ~ "Direita", 
                                   ideologia_dos_partidos == "Esquerda" ~ "Esquerda", 
                                   ideologia_dos_partidos == "Centro Esquerda" ~ "Esquerda", 
                                   ideologia_dos_partidos == "Extrema Esquerda" ~ "Esquerda", 
                                   ideologia_dos_partidos == "Centro" ~ "Centro", TRUE ~ ideologia_dos_partidos)) %>%  
  group_by(dado_agregado) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  rename(`cidades sem tarifa zero` = pct) %>% 
  select(-n) %>% 
  adorn_pct_formatting(digits = 1) %>% 
  left_join(tf, by = "dado_agregado")

```



```{r}

# Função para normalização pela escala logarítmica
normalize_log_scale <- function(x) {
  return(log(x) / log(max(x)))
}

banco_completo %>% select(cod_munic,
                          tarifa_zero,
                          populacao, 
                          caracterizacao_do_orgao_gestor,
                          escolaridade_do_a_titular_do_orgao_gestor, 
                          plano_municipal_de_transporte_existencia, 
                          possui_plano_de_mobilidade_urbana, 
                          conselho_municipal_de_transporte_existencia, 
                          fundo_municipal_de_transporte_existencia,
                          prosperidade_social, 
                          produto_interno_bruto_a_precos_correntes_r_1_000,
                          Estatutarios) %>% 
  rename(pib = produto_interno_bruto_a_precos_correntes_r_1_000) %>% 
  mutate(pib = round(pib)) %>% 
  mutate(pib_normalizado = normalize_log_scale(pib)) %>% 
  mutate(populacao_normalizado = normalize_log_scale(populacao)) %>% 
  replace(is.na("Estatutarios"), 0) %>% 
  filter(!is.na(Estatutarios)) %>% 
  mutate(estatutarios_normalizado = normalize_log_scale(Estatutarios)) %>% 
  rename(secretaria_exclusiva = caracterizacao_do_orgao_gestor) %>% 
  mutate(secretaria_exclusiva = case_when(secretaria_exclusiva %in% c("Não informou", "Não possui estrutura", "Recusa",
                               "Órgão da administração indireta", 
                               "Secretaria em conjunto com outras políticas setoriais",
                               "Setor subordinado a outra secretaria",
                               "Setor subordinado diretamente à chefia do Executivo") ~ 0,
    secretaria_exclusiva == "Secretaria exclusiva" ~ 1,
    TRUE ~ as.numeric(secretaria_exclusiva))) %>%
    mutate(tarifa_zero = case_when(tarifa_zero == "sim" ~ 1,
                                   tarifa_zero == "não" ~ 0,
    TRUE ~ as.numeric(tarifa_zero))) %>% 
   mutate(possui_plano_de_mobilidade_urbana = case_when(
    possui_plano_de_mobilidade_urbana %in% c("SIM", "Sim") ~ 1,
    possui_plano_de_mobilidade_urbana %in% c("Nao foi enviado oficio", "Nao respondeu", "Nao") ~ 0,
    TRUE ~ as.numeric(possui_plano_de_mobilidade_urbana))) %>% 
    mutate(plano_municipal_de_transporte_existencia = case_when(
    plano_municipal_de_transporte_existencia == "Sim" ~ 1,
    plano_municipal_de_transporte_existencia %in% c("Recusa", "Nao informou", "Não") ~ 0,
    TRUE ~ as.numeric(possui_plano_de_mobilidade_urbana))) %>% 
    mutate(conselho_municipal_de_transporte_existencia = case_when(
    conselho_municipal_de_transporte_existencia == "Sim" ~ 1,
    conselho_municipal_de_transporte_existencia %in% c("Recusa", "Nao informou", "Não") ~ 0,
    TRUE ~ as.numeric(conselho_municipal_de_transporte_existencia))) %>% 
    mutate(fundo_municipal_de_transporte_existencia = case_when(
    fundo_municipal_de_transporte_existencia == "Sim" ~ 1,
    fundo_municipal_de_transporte_existencia %in% c("Recusa", "Nao informou", "Não") ~ 0,
    TRUE ~ as.numeric(fundo_municipal_de_transporte_existencia))) 
  
banco_completo %>% distinct(escolaridade_do_a_titular_do_orgao_gestor)
  
```





