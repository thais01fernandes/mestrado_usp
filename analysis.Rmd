---
title: Exploratory Analysis of Municipalities in Brazil that have adopted a Fare Free
  Public Transport
author: "Thais Pereira"
date: "`r format(Sys.Date(), format='%d/%m/%Y')`"
output:
    html_document:
      theme: flatly
      self-contained: yes
      toc: yes
      toc_float: yes
      css: 
        - style.css
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}

(knitr::opts_chunk$set(
	echo = FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE
)
) 
```

```{r Pacotes}


library("tidyverse")
library("kableExtra")
library("knitr")
library("tidylog")
library("readxl")
library("geobr")
library("sf")
library("wesanderson")
library("ggplot2")
library("stringr")
library ("abjData")
library("extrafont")
library("lubridate")
library("transformr")
library("reactable")
library("rnaturalearth")
library("rgeos")
library("plotly")
library("ggrepel")
library('googlesheets4')
library("leaflet")
library('ggthemes')
library('rmdformats')
library("janitor")
library("reactablefmtr")
# install.packages("PNADcIBGE")
library(PNADcIBGE)


```

```{r Baixando os dados}

file1 <- "https://raw.githubusercontent.com/thais01fernandes/mestrado_usp/main/dados/banco_completo"
banco_completo <- read_delim(file1, delim = ",", 
                        locale = locale(encoding='UTF-8')) %>% select(-1) %>% 
                        filter(ano_implementacao != 2023 | is.na(ano_implementacao))

file2 <- "https://raw.githubusercontent.com/thais01fernandes/mestrado_usp/main/dados/eleicoes_1"
  eleicoes <- read_delim(file2, delim = ",", 
                             locale = locale(encoding='UTF-8')) %>% select(-1) 


```

## **Abstract**

This report analyse data from 65 Brazilian cities that have adopted the
full fare exemption on public transport, more popularly known in Brazil
as the "Tarifa Zero", a term that will be used in this report to refer
to this policy. For the selection of cases, three criteria were used: i.
The policy was implemented in all transport networks in the city; ii. It
is available to all users and; iii. it was not discontinued until
December 2022. We intend to present an exploratory analysis of public
data about the studied municipalities and characterize them by checking
if there is homogeneity in their economic and social characteristics, in
addition to comparing them with all others that have not adopted the
policy, with the objective to understand the differences and disparities
between the two groups of cities, based on Political Science Teories, in
order to undertand why this policy was implemented.

## **Descriptive Analysis**

## 1. General data about the municipalities

```{r Tabela inicial, fig.align = 'center', out.width = "60%"}

# tabela de apresentação dos municípios estudados 
# tabela com reactable: 
  
  options(scipen=999)
  banco_completo  %>% 
  filter(tarifa_zero == "sim") %>% 
  select(nome_da_uf, 
         nome_do_municipio, 
         classe_pop, 
         produto_interno_bruto_a_precos_correntes_r_1_000,
         produto_interno_bruto_per_capita_a_precos_correntes_r_1_00, 
         pmpob, prosperidade_social,  
         taxa_urbanizacao, 
         ar_mun_2022, 
         densidade_demografica, 
         gini, 
         theil, 
         idhm_class, 
         idhm_e_class, 
         idhm_r_class, 
         idhm_l_class, 
         ivs_class, 
         ivs_infra_urbana_class, 
         ivs_cap_class, 
         ivs_renda_trab_class) %>% 
  mutate_if(is.character, str_to_title) %>% 
  mutate(pmpob = pmpob/100) %>% 
  reactable(
      defaultPageSize = 5,
      searchable = TRUE,
      outlined = FALSE, 
      showPageInfo = TRUE, 
      showPageSizeOptions = TRUE,
      defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#c18d83")),
      columns = list(
      nome_da_uf = colDef("Federative Unit", minWidth = 105, align = "center"),
      nome_do_municipio = colDef("City", minWidth = 120, align = "center"),
      classe_pop = colDef("Population Class",  minWidth = 120, align = "center"),
      produto_interno_bruto_a_precos_correntes_r_1_000 = colDef("GDP" , format = colFormat(prefix = "R$ ", separators = TRUE), minWidth = 160),
      produto_interno_bruto_per_capita_a_precos_correntes_r_1_00 = colDef("GDP Per Capta Income" , format = colFormat(prefix = "R$ ", separators = TRUE), minWidth = 150),
      prosperidade_social = colDef("Social Prosperity", minWidth = 150),
      pmpob = colDef("% of Poor" ,  format = colFormat(percent = TRUE, digits = 1), minWidth = 120), 
      taxa_urbanizacao = colDef("Urbanization Rate" , format = colFormat(percent = TRUE, digits = 1), minWidth = 120),
      gini = colDef("Gini" ,  minWidth = 100),
      theil = colDef("Theil-L" ,  minWidth = 100),
      idhm_class = colDef("Municipal Human Development Index (MHDI)" ,  minWidth = 150),
      idhm_e_class = colDef("MHDI Education" ,  minWidth = 100),
      idhm_r_class = colDef("MHDI Income" ,  minWidth = 100), 
      idhm_l_class  = colDef("MHDI Longevidade" , minWidth = 120),
      ivs_class = colDef("Social Vulnerability Index (SVI)" , minWidth = 150), 
      ivs_infra_urbana_class = colDef("SVI Urban Infrastructure" , minWidth = 150), 
      ivs_cap_class = colDef("SVI Human Capital" , minWidth = 150), 
      ivs_renda_trab_class = colDef("SVI Income and Work" , minWidth = 150), 
      ar_mun_2022 = colDef("Territorial Area" , format = colFormat(suffix = " km²", separators = TRUE), minWidth = 150),
      densidade_demografica = colDef("Demographic Density" , format = colFormat(suffix = " hab/km²", separators = TRUE, digits = 3), minWidth = 150),
      pageSizeOptions = c(5,10,15,20,25,30), bordered = TRUE, striped = FALSE, highlight = TRUE))
     
```

## 2. Localization of municipalities

The map below shows us the location of the cities, the points represent
the municipalities:

```{r eval=FALSE, include=FALSE}

# Baixando dados para o mapa com Geobr 

# Download dos Estados e Municípios: 

muni_geobr_1 <- read_municipality(code_muni="all", year=2018) %>%  as.tibble()

geo_ufs <- read_state(code_state = 'all', year = 2018) %>% as.tibble()

geo_ufs %>%  select(geom)

# Estados: 

munic_isencao_tarifa_uf <- banco_completo %>% 
  select(uf_x,tarifa_zero) %>% 
  distinct() %>% 
  rename(code_state=uf_x)

geo_ufs_2 <- geo_ufs  %>% 
  left_join(munic_isencao_tarifa_uf, by = c("code_state")) %>% 
  replace(is.na("tarifa_zero"), "não")

# municipios: 

munic_isencao_tarifa_muni <- banco_completo  %>% 
  rename(code_muni= cod_munic) %>% 
  select(code_muni,tarifa_zero) %>% 
  distinct()

muni_geobr_3 <- muni_geobr_1 %>% 
  left_join(munic_isencao_tarifa_muni, by = c("code_muni")) %>% 
  replace(is.na("tarifa_zero"), "não") %>% 
  st_centroid() %>% 
  filter(tarifa_zero == "sim") %>% 
  rename (Municipio = name_muni)


```


```{r Mapa dos municipios, fig.align = 'center', out.width = "90%"}



# gráfico de mapa colocando os municípios dentro de seus respectivos estados:
# 
# geo_ufs_2 %>% 
# st_as_sf(coords=c("geom")) %>%
# ggplot() +
# geom_sf(aes(geometry = geom,
#            fill = as.character(tarifa_zero)), color = "white") +
# geom_sf(data=muni_geobr_3) +
# theme_light()+
# scale_fill_manual(name = "Tarifa Zero?", values = c("#c57d4b", "#7e9563"), labels = c("Não", "Sim")) +
# theme(legend.text = element_text(family = "serif", size = 12, hjust = 0.5, colour = "black"), 
#       legend.title = element_text(family = "serif", size = 12, hjust = 0.5, colour = "black"))


```

The map below shows us more detailed the location of the cities

```{r leaflet map,  fig.align = 'center', out.width = "90%"}

# Primeiro precisamos dos dados de latitude e longitude das cidades analisadas. 
urlfile <- "https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/master/csv/municipios.csv"
cities_lat_lng <- read.csv(urlfile,encoding = "UTF-8")
# é necessário se certificar que o código de cada cidade estará em formato de texto, para o que a função left_join funcione. 
cities_lat_lng$codigo_ibge <- as.double(cities_lat_lng$codigo_ibge)

ffpt_muni_5 <- banco_completo %>% rename(codigo_ibge = cod_munic) %>% 
  left_join(cities_lat_lng, by = "codigo_ibge")

tarifa_zero <- ffpt_muni_5 %>% filter(tarifa_zero == "sim") %>% select(latitude, longitude, nome_do_municipio)

  leaflet(tarifa_zero) %>%
  addTiles() %>% 
  addMarkers(popup= tarifa_zero$nome_do_municipio)



```

## 3. Region of municipalities

```{r Região dos Municípios,fig.align = 'center', out.width = "50%"}

# Tabela com a Região dos Municípios

  banco_completo  %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate(regiao = trimws(regiao)) %>% 
  group_by(regiao) %>%
  tally() %>% 
  reactable(
      outlined = F, 
      fullWidth = F,
      bordered = T,
      striped = F,
      defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#c18d83")),
      columns = list(
      regiao = colDef("Region", minWidth = 120, align = "center"),
      n = colDef("Municipalities with Tarifa Zero", minWidth = 300, align = "center")))




```

## 4. State of municipalities

```{r UF dos municípios, fig.align = 'center', out.width = "50%"}

# Tabela com a UF dos municípios 

  banco_completo  %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate(nome_da_uf = trimws(nome_da_uf)) %>% 
  group_by(nome_da_uf) %>%
  tally() %>%
  arrange(-n) %>% 
  reactable(
      outlined = F, 
      fullWidth = F,
      bordered = TRUE,
      striped = F,
     defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#c18d83")),
      columns = list(
      nome_da_uf = colDef("Federative Unit", minWidth = 150, align = "center"),
      n = colDef("Municipalities with Tarifa Zero", minWidth = 300, align = "center")))



```

## 5. Population Class

```{r}

  banco_completo %>% 
  mutate(classe_pop = factor(classe_pop, levels = c("Up to 5.000", 
                                                    "5.000 up to 10.000", 
                                                    "10.000 up to 20.000", 
                                                    "20.000 up to 50.000",
                                                    "50.000 up to 100.000", 
                                                    "100.000 up to 500.000", 
                                                    "Greater than 500.000", ordered = TRUE))) %>% 
  group_by(tarifa_zero, classe_pop) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  mutate(classe_pop = trimws(classe_pop)) %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% 
  filter(!is.na(classe_pop)) %>% 
  mutate(tarifa_zero = case_when(tarifa_zero == "sim" ~ "Municípios com Tarifa Zero", 
                                 tarifa_zero == "nao"~ "Municípios sem Tarifa Zero", TRUE ~ tarifa_zero)) %>% 
  ggplot() +
  geom_col(aes(x = reorder(classe_pop, pct), y =  pct, fill = tarifa_zero), width = 1,colour="white", alpha = 0.6) + 
  xlab("") +
  ylab("") +
  ggtitle( "") +
  facet_wrap(~tarifa_zero)+
  scale_fill_manual(name = "", values = c("gray22", "gray22"), labels = element_blank()) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  geom_label(aes(x = classe_pop, y = pct, group = tarifa_zero, label = scales::percent(pct, accuracy = 2)), 
             position = position_identity(),family = "serif", size = 4, colour = "white", fill = "#c18d83", face = "bold")+
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#c18d83"),
    strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "Lora", size = 13),
    axis.text.y=element_text(size = 10, family = "Lora"),
    axis.text.x=element_blank(),
    legend.position="none")+
    coord_flip() 


```

## 4. Year of Implementation

```{r}

banco_completo %>% 
filter(tarifa_zero == "sim") %>% 
mutate(ano_implementacao_classe = case_when(ano_implementacao <= 1998 ~ "Until 2000s", 
                                  ano_implementacao >= 2001 & ano_implementacao  <= 2009 ~ "Between 2001 and 2009",
                                  ano_implementacao >= 2010 & ano_implementacao <= 2015 ~  "Between 2010 and 2015", 
                                  ano_implementacao >= 2016 & ano_implementacao <= 2020 ~ "Between 2016 and 2020", 
                                  ano_implementacao >= 2020  ~ "After 2021", 
                                  TRUE ~ "NA")) %>% 
mutate(ano_implementacao_classe = factor(ano_implementacao_classe, levels = c("Until 2000s", 
                                                                          "Between 2001 and 2009", 
                                                                          "Between 2010 and 2015", 
                                                                          "Between 2016 and 2020",
                                                                          "After 2021", ordered = T))) %>% 
group_by(ano_implementacao_classe) %>% 
tally() %>% 
mutate(pct = n/sum(n)) %>% 
ggplot() +
  geom_col(aes(x = reorder(ano_implementacao_classe, pct), y =  pct), width = 1,colour="white", alpha = 0.6) + 
  xlab("") +
  ylab("") +
  ggtitle( "") +
  scale_fill_manual(name = "", values = c("gray22", "gray22"), labels = element_blank()) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  geom_label(aes(x = ano_implementacao_classe, y = pct, label = scales::percent(pct, accuracy = 2)), 
             position = position_identity(),family = "serif", size = 4, colour = "white", fill = "#c18d83", face = "bold")+
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#c18d83"),
    strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "Lora", size = 13),
    axis.text.y=element_text(size = 10, family = "Lora"),
    axis.text.x=element_blank(),
    legend.position="none")+
    coord_flip() 

```

------------------------------------------------------------------------

## **Exploratory Analysis**

## 1.Análise da Teoria do Eleitor Mediano

**1° Premissa:** "Quanto maior a desigualdade, maior a exigência por
serviços públicos e consequente aumento do gasto público. Portanto,
cidades com tarifa zero devem ser mais desiguais do que cidades sem essa
política."

Para verificar se essa premissa de fato pode nos ajudar a explicar a
tarifa zero, vejamos primeiro o Gini e o Theil-L, ambos são índices de
desigualdade amplamente utilizados, medem o grau de concentração de
renda em determinado grupo e variam de 0 a 1, sendo 0 uma situação de
completa igualdade e 1 uma situação de completa desigualdade, nesse caso
estão usando dados do censo de 2010.

```{r Indice de Gini e Theil media geral}

# Indíce de Gini médias

media_indice_gini_tf <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(median(gini)) %>% 
  round(digits = 2) %>% 
  pull()

media_indice_gini_geral <- banco_completo %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(median(gini, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()

# Indíce de  Theil 

media_indice_theil_tf <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(median(theil)) %>% 
  round(digits = 2) %>% 
  pull()

media_indice_theil_geral <- banco_completo %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(median(theil, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()



```

degree of income concentration in a given group and range from 0 to 1, 0
being a situation of complete equality, and 1 being a situation of
complete inequality, in addition both are using data from the 2010
census. The general median of the Gini index in the studied cities is
`r media_indice_gini_tf`, while for municipalities without a Zero Tariff
it is `r media_indice_gini_geral`. There is only a small difference in
the averages. And the same is true for the Theil-L index, where the
median in the first group is `r media_indice_theil_tf`, while in the
second group it is `r media_indice_theil_geral`, but similarly the
municipalities with Tarifa Zero present values that indicate less social
inequality. Below we can see the distribution graph of the values of the
two indexes for all the municipalities with a Tarifa Zero:

```{r Gráfico GINI e Theil 1, fig.align = 'center', out.width = "70%", dpi=300}


# Labels: 

label_gini_theil <- banco_completo %>% 
    pivot_longer(cols = c("gini", "theil")) %>%
    mutate(name = case_when(
    name == "gini" ~ "Gini",
    name == "theil" ~ "Theil-L")) %>% 
    group_by(name, tarifa_zero) %>% 
    summarise(value = median(value, na.rm = TRUE))

# Gráficos


banco_completo %>% 
 pivot_longer(cols = c("gini", "theil")) %>%
  mutate(name = case_when(
    name == "gini" ~ "Gini",
    name == "theil" ~ "Theil-L")) %>% 
    ggplot() +
    geom_boxplot(aes(x = tarifa_zero, y = value, fill = tarifa_zero), colour="black", alpha = 0.9) +
    geom_label(data = label_gini_theil, aes(tarifa_zero, value, label = value), 
              vjust = 0.5, size = 3) + 
  facet_wrap(~name) +
  theme_light() +
  ggtitle("Boxplot do Índice de Gini e de Theil") +
  xlab("") +
  ylab("") +
  labs(caption = "Fonte: IBGE, 2010 
                  Elaboração Própria") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#c57d4b", "#7e9563"), labels = c("Não", "Sim"))+ 
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#579296"),
          plot.caption = element_text(family = "serif", size = 10),
  strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 14),
    axis.text.x=element_blank(),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.position = "bottom")



```

Tabela Separandos os valores por UF:

```{r fig.align = 'center', out.width = "70%", dpi=300}

  ffpt <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  select(regiao, gini, theil) %>% 
  group_by(regiao) %>% 
  summarise(media_gini_tf = median(gini), media_theil_tf = median(theil))



# munic sem ffpt:

 tabela_desigualdade <- banco_completo %>% 
  filter(tarifa_zero == "não") %>%
  select(regiao, gini, theil) %>% 
  group_by(regiao) %>% 
  summarise(media_gini_geral = median(gini), media_theil_geral = median(theil)) %>% 
  left_join(ffpt, by = "regiao") %>% 
  select(regiao, media_gini_geral, media_gini_tf, media_theil_geral, media_theil_tf) %>% 
      reactable(
      fullWidth = F,
      defaultColDef = colDef(
      align = "center"),
      columns = list(
      regiao = colDef("Região", minWidth = 130),
      media_gini_tf = colDef("Cidades com Tarifa Zero", minWidth = 130),
      media_gini_geral = colDef("Cidades sem Tarifa Zero", minWidth = 130),
      media_theil_tf = colDef("Cidades com Tarifa Zero", minWidth = 130),
     media_theil_geral = colDef("Cidades sem Tarifa Zero", minWidth = 130)),
    columnGroups = list(
    colGroup(name = "Índice de Gini", columns = c("media_gini_tf", "media_gini_geral" )),
    colGroup(name = "Índice de Theil", columns = c("media_theil_geral", "media_theil_tf"))))
 
 tabela_desigualdade %>% 
     add_source("Fonte: IBGE, 2010", font_size = 12, align = "left", margin = margin(t = 12))  


```

**2° Premissa:** "Quanto menor a riqueza medida através do PIB, maior a
demanda por políticas redistributivas. Dessa forma, cidades com tarifa
zero dispõem de menor PIB per capita do que cidades sem essa política."

Para essa análise fizemos um corte comparando apenas as cidades com até
150 mil reais de PIB per capta, tanto com tarifa zero quanto sem tarifa
zero. Isso não significa retirar muitas cidades da base de dados já que
99,45% das cidades sem tarifa zero (e com menos de 300 mil habitantes)
estão dentro desse valor de PIB per capita, no caso das cidades com
tarifa zero, isso representa 96,4% das cidades, essa foi uma forma de
retirar os valores discrepantes da análise e torná-la mais evidente.

```{r PIB Gráfico, fig.align = 'center', out.width = "70%", dpi=300}


# labels: 

label_pib <- banco_completo %>% 
  rename(pib_per_capta = produto_interno_bruto_per_capita_a_precos_correntes_r_1_00) %>% 
  filter(pib_per_capta < 150000) %>% 
  group_by(tarifa_zero) %>% 
  summarise(pib_per_capta = median(pib_per_capta)) %>% 
  mutate(pib_per_capta = round(pib_per_capta))


# Gráfico

banco_completo %>% 
  rename(pib_per_capta = produto_interno_bruto_per_capita_a_precos_correntes_r_1_00) %>% 
  filter(pib_per_capta < 150000) %>% 
  ggplot() +
  geom_boxplot(aes(x = tarifa_zero, y = pib_per_capta, fill = tarifa_zero), colour="black", alpha = 0.9) + 
  geom_label(data = label_pib, aes(x = tarifa_zero, y = pib_per_capta, label = scales::dollar(prefix = "R$ ", round(pib_per_capta, 1))), size = 3) +
  theme_light() +
  xlab("") +
  ylab("") +
  ggtitle("Boxplot do PIB per capta") +
  labs(caption = "Fonte: IBGE, 2020 
                  Elaboração Própria") +
  scale_y_continuous(
  labels = scales::label_dollar(prefix = "R$ ",
                                  big.mark = ".")) + 
  scale_fill_manual(name = "Tarifa Zero?", values = c("#c57d4b", "#7e9563"), labels = c("Não", "Sim"))+ 
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          plot.caption = element_text(family = "serif", size = 10),
    text = element_text(family = "serif", size = 14),
    axis.text.x=element_blank(),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.position = "bottom")



```

```{r}

# Medianas do PIB

media_indice_pib_tf <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  filter(produto_interno_bruto_per_capita_a_precos_correntes_r_1_00 < 150000) %>% 
  summarize(median(produto_interno_bruto_per_capita_a_precos_correntes_r_1_00)) %>% 
  round(digits = 3) %>% 
  pull()

media_indice_pib_geral <- banco_completo %>% 
  filter(tarifa_zero != "sim") %>% 
  filter(produto_interno_bruto_per_capita_a_precos_correntes_r_1_00 < 150000) %>% 
  summarize(median(produto_interno_bruto_per_capita_a_precos_correntes_r_1_00, na.rm = TRUE)) %>% 
  round(digits = 3) %>% 
  pull()


```



Tabela Separandos os valores por UF:

```{r PIB tabela}

ffpt <- banco_completo %>% 
  rename(pib_per_capta = produto_interno_bruto_per_capita_a_precos_correntes_r_1_00) %>% 
  filter(pib_per_capta < 150000) %>% 
  filter(tarifa_zero == "sim") %>% 
  select(regiao, pib_per_capta) %>% 
  group_by(regiao) %>% 
  summarise(media_pib = median(pib_per_capta))


# munic sem ffpt:

  banco_completo %>% 
  rename(pib_per_capta = produto_interno_bruto_per_capita_a_precos_correntes_r_1_00) %>% 
  filter(pib_per_capta < 150000) %>%
  filter(tarifa_zero == "não") %>% 
  select(regiao, pib_per_capta) %>% 
  group_by(regiao) %>% 
  summarise(media_pib = median(pib_per_capta)) %>% 
  left_join(ffpt, by = "regiao") %>% 
  select(regiao, media_pib.x, media_pib.y) %>% 
      reactable(
      fullWidth = F,
      defaultColDef = colDef(
      align = "center"),
      columns = list(
      regiao = colDef("Região", minWidth = 130),
      media_pib.y = colDef("Cidades com Tarifa Zero", format = colFormat(prefix = "R$ ", separators = TRUE), minWidth = 130),
      media_pib.x = colDef("Cidades sem Tarifa Zero", format = colFormat(prefix = "R$ ", separators = TRUE),  minWidth = 130)))

  


```

**3° premissa** Trabalhadores informais são mais favoráveis à política pois não usufruem da política de vale transporte limitada à trabalhadores formais, por isso nas cidades com tarifa zero há mais trabalhadores informais do que formais. 


```{r eval=FALSE, include=FALSE}

dadosPNADc_brutos <- get_pnadc(year=2017, quarter=4, vars=c("V2009","V4009","V4012", "V4029"), design=FALSE)


```

**4° premissa** Quanto maior a competitividade das eleições anteriores a adoção da política maior a pressão do eleitor mediano por políticas sociais. Se essa premissa for verdadeira, esperamos encontrar menor diferença média na quantidade de votos recebidos pelo prefeito e o candidato em 2° lugar nas eleições anteriores à adoção da política nas cidades com tarifa zero 



```{r}


eleicoes %>% 
  group_by(tarifa_zero) %>% 
  mutate(tarifa_zero = case_when(tarifa_zero == "sim" ~ "sim", 
                                 TRUE ~ "nao")) %>% 
  summarize(mediana = median(diferenca_votos, na.rm  = TRUE))

```


```{r}

mediana_diferenca_votos <- eleicoes %>% 
  group_by(tarifa_zero) %>% 
  mutate(tarifa_zero = case_when(tarifa_zero == "sim" ~ "sim", 
                                 TRUE ~ "não")) %>% 
  summarize(diferenca_votos = median(diferenca_votos, na.rm  = TRUE))

eleicoes %>% 
  mutate(tarifa_zero = case_when(tarifa_zero == "sim" ~ "sim", 
                                 TRUE ~ "não")) %>% 
 ggplot() +
 geom_boxplot(aes(x = tarifa_zero, y = diferenca_votos, fill = tarifa_zero), colour="black", alpha = 0.9) + 
 geom_label(data = mediana_diferenca_votos, aes(tarifa_zero, diferenca_votos, label = diferenca_votos), 
              vjust = 0.005, size = 3, 
              colour = "#394B41", fill = "beige", face = "bold") + 
  theme_light() +
  ggtitle("Boxplot das diferenças de votos entre o candidato eleito e segundo colocado") +
  xlab("") +
  ylab("") +
  labs(caption = "Fonte: TSE, 
                  Elaboração Própria") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#c57d4b", "#7e9563"), labels = c("Não", "Sim")) + 
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#579296"),
          plot.caption = element_text(family = "serif", size = 10),
  strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 14),
    axis.text.x=element_blank(),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.position = "bottom")


```

## 2. Teoria das Capacidades Estatais 

**1° premissa:** Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Por isso cidades com tarifa zero devem possuir mais secretarias exclusivas do que cidades sem essa política


```{r}

ffpt_orgao <- banco_completo %>% 
  mutate(caracterizacao_do_orgao_gestor = case_when(caracterizacao_do_orgao_gestor =="Não informou" ~ "Não informou",
                                                      caracterizacao_do_orgao_gestor == "Não possui estrutura" ~ "Secretaria não exclusiva", 
                                                      caracterizacao_do_orgao_gestor == "Recusa" ~ "Não informou",
                                                      caracterizacao_do_orgao_gestor == "Órgão da administração indireta" ~ "Secretaria não exclusiva", 
                                                      caracterizacao_do_orgao_gestor == "Secretaria em conjunto com outras políticas setoriais"  ~ "Secretaria não exclusiva",
                                                      caracterizacao_do_orgao_gestor == "Setor subordinado a outra secretaria" ~ "Secretaria não exclusiva",
                                                      caracterizacao_do_orgao_gestor == "Setor subordinado diretamente à chefia do Executivo"  ~ "Secretaria não exclusiva",
                                                      TRUE~(caracterizacao_do_orgao_gestor))) %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(caracterizacao_do_orgao_gestor) %>% 
  tally() %>% 
  mutate(pct_ffpt = n/sum(n)) %>% 
  select(-2)

banco_completo %>% 
  mutate(caracterizacao_do_orgao_gestor = case_when(caracterizacao_do_orgao_gestor =="Não informou" ~ "Não informou",
                                                      caracterizacao_do_orgao_gestor == "Não possui estrutura" ~ "Secretaria não exclusiva", 
                                                      caracterizacao_do_orgao_gestor == "Recusa" ~ "Não informou",
                                                      caracterizacao_do_orgao_gestor == "Órgão da administração indireta" ~ "Secretaria não exclusiva", 
                                                      caracterizacao_do_orgao_gestor == "Secretaria em conjunto com outras políticas setoriais"  ~ "Secretaria não exclusiva",
                                                      caracterizacao_do_orgao_gestor == "Setor subordinado a outra secretaria" ~ "Secretaria não exclusiva",
                                                      caracterizacao_do_orgao_gestor == "Setor subordinado diretamente à chefia do Executivo"  ~ "Secretaria não exclusiva",
                                                      TRUE~(caracterizacao_do_orgao_gestor))) %>% 
  filter(tarifa_zero == "não") %>% 
  group_by(caracterizacao_do_orgao_gestor) %>% 
  tally() %>% 
  mutate(pct_geral = n/sum(n)) %>% 
  select(-2) %>% 
  left_join(ffpt_orgao, by = "caracterizacao_do_orgao_gestor") %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% 
  adorn_pct_formatting(digits = 0) %>% 
  kbl(col.names = c("Caracterização do orgão gestor", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 11: Caracterização do Orgão Gestor") %>%
  kable_classic(full_width = F , html_font = "Cambria") %>% 
  footnote(general = "IBGE, 2021 ",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )
  
  
```


**2° premissa:**Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Por isso cidades com tarifa zero possuem gestores com mais qualificação acadêmica. 


```{r}

ffpt_escolaridade <- banco_completo %>% 
    filter(escolaridade_do_a_titular_do_orgao_gestor == "Doutorado" |
         escolaridade_do_a_titular_do_orgao_gestor == "Ensino médio (2º Grau) completo"|
         escolaridade_do_a_titular_do_orgao_gestor == "Ensino superior completo"|
         escolaridade_do_a_titular_do_orgao_gestor == "Especialização" | 
         escolaridade_do_a_titular_do_orgao_gestor == "Mestrado") %>% 
  mutate(escolaridade_do_a_titular_do_orgao_gestor = factor(escolaridade_do_a_titular_do_orgao_gestor, levels = c("Ensino médio (2º Grau) completo", 
                                                   "Ensino superior completo", 
                                                   "Especialização", 
                                                   "Mestrado",
                                                   "Doutorado", ordered = TRUE))) %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(escolaridade_do_a_titular_do_orgao_gestor) %>% 
  tally() %>% 
  mutate(pct_ffpt = n/sum(n)) %>% 
  select(-2)

banco_completo %>% 
    filter(escolaridade_do_a_titular_do_orgao_gestor == "Doutorado" |
         escolaridade_do_a_titular_do_orgao_gestor == "Ensino médio (2º Grau) completo"|
         escolaridade_do_a_titular_do_orgao_gestor == "Ensino superior completo"|
         escolaridade_do_a_titular_do_orgao_gestor == "Especialização" | 
         escolaridade_do_a_titular_do_orgao_gestor == "Mestrado") %>% 
  mutate(escolaridade_do_a_titular_do_orgao_gestor = factor(escolaridade_do_a_titular_do_orgao_gestor, levels = c("Ensino médio (2º Grau) completo", 
                                                   "Ensino superior completo", 
                                                   "Especialização", 
                                                   "Mestrado",
                                                   "Doutorado", ordered = TRUE))) %>% 
  filter(tarifa_zero == "não") %>% 
  group_by(escolaridade_do_a_titular_do_orgao_gestor) %>% 
  tally() %>% 
  mutate(pct_escol = n/sum(n)) %>% 
  select(-2) %>% 
  left_join(ffpt_escolaridade, by = "escolaridade_do_a_titular_do_orgao_gestor") %>% 
  adorn_pct_formatting(digits = 0) %>% 
mutate(pct_ffpt = gsub(pattern = "-",replacement = "0%", pct_ffpt)) %>% 
kbl(col.names = c("Escolaridade", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 12: Escolaridade do Titular do Orgão Gestor") %>%
kable_classic(full_width = F , html_font = "Cambria") %>% 
footnote(general = "IBGE, 2021 ",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )
  

```


**3° premissa:** Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Por isso cidades com tarifa zero dispõem de maior quantidade de conselhos de transporte público em relação à cidades sem a política 


```{r}

ffpt_conselho <- banco_completo %>% 
       mutate(conselho_municipal_de_transporte_existencia =case_when(conselho_municipal_de_transporte_existencia =="Não" ~"Não ou não informou",
                                                       conselho_municipal_de_transporte_existencia == "Não informou" ~ "Não ou não informou", 
                                                       conselho_municipal_de_transporte_existencia == "Recusa" ~ "Não ou não informou",
                                                       TRUE~(conselho_municipal_de_transporte_existencia))) %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(conselho_municipal_de_transporte_existencia) %>% 
  tally() %>% 
  mutate(pct_ffpt = n/sum(n)) %>% 
  select(-2)

banco_completo %>% 
         mutate(conselho_municipal_de_transporte_existencia =case_when(conselho_municipal_de_transporte_existencia =="Não" ~"Não ou não informou",
                                                       conselho_municipal_de_transporte_existencia == "Não informou" ~ "Não ou não informou", 
                                                       conselho_municipal_de_transporte_existencia == "Recusa" ~ "Não ou não informou",
                                                       TRUE~(conselho_municipal_de_transporte_existencia))) %>% 
  filter(tarifa_zero == "não") %>% 
  group_by(conselho_municipal_de_transporte_existencia) %>% 
  tally() %>% 
  mutate(pct_conselho = n/sum(n)) %>% 
  select(-2) %>% 
  left_join(ffpt_conselho, by = "conselho_municipal_de_transporte_existencia") %>% 
  adorn_pct_formatting(digits = 0) %>% 
kbl(col.names = c("Existe Conselho na Cidade?", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 13: Existência de Conselho Municipal de Transporte") %>%
kable_classic(full_width = F , html_font = "Cambria") %>% 
footnote(general = "IBGE, 2021 ",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )
  

```

**4° premissa:** Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Por isso cidades com tarifa zero dispõem de Fundo Municipal de Transporte em relação à cidades sem a política 

```{r}

ffpt_fundo <- banco_completo %>% 
  mutate(fundo_municipal_de_transporte_existencia = case_when(fundo_municipal_de_transporte_existencia =="Não" ~"Não ou não informou",
                                                      fundo_municipal_de_transporte_existencia == "Não informou" ~ "Não ou não informou", 
                                                      fundo_municipal_de_transporte_existencia == "Recusa" ~ "Não ou não informou",
                                                       TRUE~(fundo_municipal_de_transporte_existencia))) %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(fundo_municipal_de_transporte_existencia) %>% 
  tally() %>% 
  mutate(pct_ffpt = n/sum(n)) %>% 
  select(-2)

banco_completo %>%
  mutate(fundo_municipal_de_transporte_existencia = case_when(fundo_municipal_de_transporte_existencia =="Não" ~"Não ou não informou",
                                                       fundo_municipal_de_transporte_existencia == "Não informou" ~ "Não ou não informou", 
                                                       fundo_municipal_de_transporte_existencia == "Recusa" ~ "Não ou não informou",
                                                       TRUE~(fundo_municipal_de_transporte_existencia))) %>% 
  filter(tarifa_zero == "não") %>% 
  group_by(fundo_municipal_de_transporte_existencia) %>% 
  tally() %>% 
  mutate(pct_conselho = n/sum(n)) %>% 
  select(-2) %>% 
  left_join(ffpt_fundo, by = "fundo_municipal_de_transporte_existencia") %>% 
  adorn_pct_formatting(digits = 0) %>% 
kbl(col.names = c("Existe Fundo Municipal?", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 14: Existência de Fundo Municipal de Transporte") %>%
kable_classic(full_width = F, html_font = "Cambria") %>% 
footnote(general = "IBGE, 2021 ",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )
  

```


**5° premissa:** Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Por isso cidades com tarifa zero dispõem de Plano de Mobilidade Urbana em mais cidades do que em relação à cidades sem a política 


```{r}


ffpt_plano <- banco_completo %>% 
     mutate(possui_plano_de_mobilidade_urbana =case_when(possui_plano_de_mobilidade_urbana =="SIM" ~"Sim",
                                                       possui_plano_de_mobilidade_urbana == "Nao foi enviado oficio" ~ "Não ou não respondeu", 
                                                       possui_plano_de_mobilidade_urbana == "Nao respondeu" ~ "Não ou não respondeu",
                                                       possui_plano_de_mobilidade_urbana == "Nao" ~ "Não ou não respondeu",
                                                       TRUE~(possui_plano_de_mobilidade_urbana))) %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(possui_plano_de_mobilidade_urbana) %>% 
  tally() %>% 
  mutate(pct_ffpt = n/sum(n)) %>% 
  select(-2)

banco_completo %>% 
     mutate(possui_plano_de_mobilidade_urbana =case_when(possui_plano_de_mobilidade_urbana =="SIM" ~"Sim",
                                                       possui_plano_de_mobilidade_urbana == "Nao foi enviado oficio" ~ "Não ou não respondeu", 
                                                       possui_plano_de_mobilidade_urbana == "Nao respondeu" ~ "Não ou não respondeu",
                                                       possui_plano_de_mobilidade_urbana == "Nao" ~ "Não ou não respondeu",
                                                       TRUE~(possui_plano_de_mobilidade_urbana))) %>% 
  filter(tarifa_zero == "não") %>% 
  group_by(possui_plano_de_mobilidade_urbana) %>% 
  tally() %>% 
  mutate(pct_conselho = n/sum(n)) %>% 
  select(-2) %>% 
  left_join(ffpt_plano, by = "possui_plano_de_mobilidade_urbana") %>% 
  adorn_pct_formatting(digits = 0) %>% 
kbl(col.names = c("Existe Plano de Mobilidade Urbana?", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 15: Existência de Plano de Mobilidade Urbana") %>%
kable_classic(full_width = F, html_font = "Cambria") %>% 
footnote(general = "IBGE, 2021 ",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )
  

```


**6° premissa:** Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Por isso cidades com tarifa zero dispõem de maior "Prosperidade Social" indicador definido pelo IPEA

```{r}


  ffpt_ps <- banco_completo %>% 
  mutate(prosperidade_social = factor(prosperidade_social, levels = c("Muito Alto", 
                                                   "Alto", 
                                                   "Baixo", 
                                                   "Muito Baixo",
                                                   "Médio", ordered = TRUE))) %>%
  filter(tarifa_zero == "sim") %>% 
  group_by(prosperidade_social) %>% 
  tally() %>% 
  mutate(pct_ffpt = n/sum(n)) %>% 
  select(-2)

banco_completo %>% 
  mutate(prosperidade_social = factor(prosperidade_social, levels = c("Muito Alto", 
                                                   "Alto", 
                                                   "Baixo", 
                                                   "Muito Baixo",
                                                   "Médio", ordered = TRUE))) %>%
  filter(tarifa_zero == "não") %>% 
  group_by(prosperidade_social) %>% 
  tally() %>% 
  mutate(pct_geral = n/sum(n)) %>% 
  select(-2) %>% 
  left_join(ffpt_ps, by = "prosperidade_social") %>% 
  adorn_pct_formatting(digits = 0) %>% 
  mutate(pct_ffpt = gsub(pattern = "-",replacement = "0%", pct_ffpt)) %>% 
kbl(col.names = c("Índice de Prosperidade Social", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 16: Índice de Prosperidade Social") %>%
kable_classic(full_width = F, html_font = "Cambria") %>% 
footnote(general = "IPEA, 2010",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )


```

**7° premissa:** Cidades que implementam políticas redistributivas dispõem de mais recursos e melhor capacidade administrativa. Verificar a quantidade de funcionários estatutários dos municípios da administração direta - Carreira estável e recrutamento baseado no mérito produz capacidade estatal para adoção de políticas urbanas


```{r}

recursos_humanos_ffpt <- 
banco_completo %>% 
mutate(Estatutarios = as.double(Estatutarios), Celetistas = as.double(Celetistas), Estagiarios = as.double(Estagiarios), `Sem vinculo Permanente` = as.double(sem_vinculo_permanente)) %>% 
pivot_longer(cols = c("Estatutarios", "Celetistas", "Comissionados", "Estagiarios", "Sem vinculo Permanente")) %>% 
group_by(tarifa_zero, name) %>% 
summarise(media_ffpt = median(value, na.rm = TRUE)) %>% 
filter(tarifa_zero == "sim") %>% 
ungroup() %>% 
select(-tarifa_zero)


banco_completo %>% 
mutate(Estatutarios = as.double(Estatutarios), Celetistas = as.double(Celetistas), Estagiarios = as.double(Estagiarios), `Sem vinculo Permanente` = as.double(sem_vinculo_permanente)) %>% 
pivot_longer(cols = c("Estatutarios", "Celetistas", "Comissionados", "Estagiarios", "Sem vinculo Permanente")) %>% 
group_by(tarifa_zero, name) %>% 
summarise(media_geral = median(value, na.rm = TRUE)) %>% 
filter(tarifa_zero == "não") %>% 
ungroup() %>% 
left_join(recursos_humanos_ffpt, by = "name") %>% 
select(-tarifa_zero) %>% 
kbl(col.names = c("Regime de Contratação", "Cidades sem Tarifa Zero", "Cidades com Tarifa Zero"), caption = "Tabela 17: Regime de Contratação dos Funcionários da Administração Direta") %>%
kable_classic(full_width = F , html_font = "Times New Roman") %>% 
footnote(general = "IBGE, 2021 ",
           general_title = "Fonte: ", number_title = "Type I: ",
           footnote_as_chunk = T, title_format = c("italic")
           )



```



