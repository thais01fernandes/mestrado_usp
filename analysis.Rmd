---
title: Exploratory Analysis of Municipalities in Brazil that have adopted a Fare Free
  Public Transport
author: "Thais Pereira"
date: "`r format(Sys.Date(), format='%d/%m/%Y')`"
output:
  html_document:
    includes:
        before_body: logo-option.html
        toc: yes
        toc_float: yes
        df_print: default
        code_folding: true
---

```{r setup, include=FALSE}

(knitr::opts_chunk$set(
	echo = FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE
)
) 
```

```{css}

  .title {
  margin-top: 1.50em !important;
  margin-bottom: 0.75em;
}

@import url('https://fonts.googleapis.com/css2?family=Lora:wght@500&display=swap');

h1.title{ 
    font-family: 'Lora', serif;
    color: #bf7d70;
    font-size: 30px;
    text-align: center;
    font-weight: bold;
}

h2 {
  font-family: 'Lora', serif;
  font-size: 15px;
  text-align: justify;
}

h4.author{ 
    font-family: 'Lora', serif;
    color: #bf7d70;
    font-size: 20px;
    text-align: center;
    font-weight: bold;
}

h4.date{ 
    font-family: 'Lora', serif;
    color: #bf7d70;
    font-size: 12px;
    text-align: center;
    font-weight: bold;
}

p{
  font-family: 'Lora', serif;
  text-align: justify;
  font-size: 13px
}

h1, .h1, h2, .h2, h3, .h3 , h4, .h4, h5, .h5, h6, .h6, h7, .h7, h8, .h8 {
    margin-top: 40px;
}


/*------------Table of Contents (TOC)----------- */

/*----------TOC Sticky Fix---------*/


.main-container > .row:first-child > div:first-child.col-xs-12.col-sm-4.col-md-3{
  position: sticky;
  top: 10px;
}

#TOC{ 
  position: initial;
  width: 100%;
  font-size: 14px;
}

/*----------TOC Sticky Adjustment---------*/

.tocify ul, .tocify li { /* Increases spacing between TOC headers*/
    line-height: 20px !important;
}

.tocify ul {
  border-right: solid 1px #eee; /* Thin right border on TOC list */
}



/* Active TOC links*/

.list-group-item.active, 
.list-group-item.active:hover{
  color:"White";
  background-color: #a7ae9c;
  font-family: 'Lora', serif;
  border-color: #ccc;
  font-size: 14px;
  text-align: left;
}

/* Hovered TOC links*/

.list-group-item:hover { 
  color: "White";
  background-color: #a7ae9c;
  font-family: 'Lora', serif;
  border: none;
  font-size: 14px;
  text-align: left;
}

/*----------LOGO above TOC---------*/

#TOC::before {
  content: "";
  display: block;
  height: 120px;
  margin: 2em 15px 35px 15px;
  background-image: url("onibus.png");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}



```


```{r Pacotes}


library("tidyverse")
library("kableExtra")
library("knitr")
library("tidylog")
library("readxl")
library("geobr")
library("sf")
library("wesanderson")
library("ggplot2")
library("stringr")
library ("abjData")
library("extrafont")
library("lubridate")
library("transformr")
library("reactable")
library("rnaturalearth")
library("rgeos")
library("plotly")
library("ggrepel")
library('googlesheets4')
library("leaflet")
library('ggthemes')
library('rmdformats')


```


```{r Baixando os dados}

file1 <- "https://raw.githubusercontent.com/thais01fernandes/mestrado_usp/main/dados/banco_completo"
banco_completo <- read_delim(file1, delim = ",", 
                        locale = locale(encoding='latin1')) %>% select(-1)


```

## **Abstract**

This report analyse data from 65 Brazilian cities that have adopted the full fare exemption on public transport, more popularly known in Brazil as the "Tarifa Zero", a term that will be used in this report to refer to this policy. For the selection of cases, three criteria were used: i. The policy was implemented in all transport networks in the city; ii. It is available to all users and; iii. it was not discontinued until December 2022. We intend to present an exploratory analysis of public data about the studied municipalities and characterize them by checking if there is homogeneity in their economic and social characteristics, in addition to comparing them with all others that have not adopted the policy, with the objective to understand the differences and disparities between the two groups of cities, based on Political Science Teories, in order to undertand why this policy was implemented. 

## **Descriptive Analysis**

## 1. General data about the municipalities

```{r Tabela inicial, fig.align = 'center', out.width = "60%"}

# tabela de apresentação dos municípios estudados 
# tabela com reactable: 
  
  options(scipen=999)
  banco_completo  %>% 
  filter(tarifa_zero == "sim") %>% 
  select(nome_da_uf, 
         nome_do_municipio, 
         classe_pop, 
         produto_interno_bruto_a_precos_correntes_r_1_000,
         produto_interno_bruto_per_capita_a_precos_correntes_r_1_00, 
         pmpob, prosperidade_social,  
         taxa_urbanizacao, 
         ar_mun_2022, 
         densidade_demografica, 
         gini, 
         theil, 
         idhm_class, 
         idhm_e_class, 
         idhm_r_class, 
         idhm_l_class, 
         ivs_class, 
         ivs_infra_urbana_class, 
         ivs_cap_class, 
         ivs_renda_trab_class) %>% 
  mutate_if(is.character, str_to_title) %>% 
  mutate(pmpob = pmpob/100) %>% 
  reactable(
      defaultPageSize = 5,
      searchable = TRUE,
      outlined = FALSE, 
      showPageInfo = TRUE, 
      showPageSizeOptions = TRUE,
      defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#c18d83")),
      columns = list(
      nome_da_uf = colDef("Federative Unit", minWidth = 105, align = "center"),
      nome_do_municipio = colDef("City", minWidth = 120, align = "center"),
      classe_pop = colDef("Population Class",  minWidth = 120, align = "center"),
      produto_interno_bruto_a_precos_correntes_r_1_000 = colDef("GDP" , format = colFormat(prefix = "R$ ", separators = TRUE), minWidth = 160),
      produto_interno_bruto_per_capita_a_precos_correntes_r_1_00 = colDef("GDP Per Capta Income" , format = colFormat(prefix = "R$ ", separators = TRUE), minWidth = 150),
      prosperidade_social = colDef("Social Prosperity", minWidth = 150),
      pmpob = colDef("% of Poor" ,  format = colFormat(percent = TRUE, digits = 1), minWidth = 120), 
      taxa_urbanizacao = colDef("Urbanization Rate" , format = colFormat(percent = TRUE, digits = 1), minWidth = 120),
      gini = colDef("Gini" ,  minWidth = 100),
      theil = colDef("Theil-L" ,  minWidth = 100),
      idhm_class = colDef("Municipal Human Development Index (MHDI)" ,  minWidth = 150),
      idhm_e_class = colDef("MHDI Education" ,  minWidth = 100),
      idhm_r_class = colDef("MHDI Income" ,  minWidth = 100), 
      idhm_l_class  = colDef("MHDI Longevidade" , minWidth = 120),
      ivs_class = colDef("Social Vulnerability Index (SVI)" , minWidth = 150), 
      ivs_infra_urbana_class = colDef("SVI Urban Infrastructure" , minWidth = 150), 
      ivs_cap_class = colDef("SVI Human Capital" , minWidth = 150), 
      ivs_renda_trab_class = colDef("SVI Income and Work" , minWidth = 150), 
      ar_mun_2022 = colDef("Territorial Area" , format = colFormat(suffix = " km²", separators = TRUE), minWidth = 150),
      densidade_demografica = colDef("Demographic Density" , format = colFormat(suffix = " hab/km²", separators = TRUE, digits = 3), minWidth = 150),
      pageSizeOptions = c(5,10,15,20,25,30), bordered = TRUE, striped = FALSE, highlight = TRUE))
     
```

## 2.  Localization of municipalities

The map below shows us the location of the cities, the points
represent the municipalities: 

```{r Download GEObr, include=FALSE}

# Download dos Estados e Municípios: 

muni_geobr_1 <- read_municipality(code_muni="all", year=2018)

geo_ufs <- read_state(code_state = 'all', year = 2018)

# Estados: 

  munic_isencao_tarifa_uf <- banco_completo %>% 
  select(uf_x,tarifa_zero) %>% 
  distinct() %>% 
  rename(code_state=uf_x)

  geo_ufs_2 <- geo_ufs  %>% 
  left_join(munic_isencao_tarifa_uf, by = c("code_state")) %>% 
  replace(is.na("tarifa_zero"), "não")

# municipios: 

  munic_isencao_tarifa_muni <- banco_completo  %>% 
  rename(code_muni= cod_munic) %>% 
  select(code_muni,tarifa_zero) %>% 
  distinct()

  muni_geobr_3 <- muni_geobr_1 %>% 
  left_join(munic_isencao_tarifa_muni, by = c("code_muni")) %>% 
  replace(is.na("tarifa_zero"), "não") %>% 
  st_centroid() %>% 
  filter(tarifa_zero == "sim") %>% 
  rename (Municipio = name_muni)
  

```


```{r Mapa dos municipios, fig.align = 'center', out.width = "90%"}


# gráfico de mapa colocando os municípios dentro de seus respectivos estados:

geo_ufs_2 %>%
st_as_sf(coords=c("geom")) %>%
ggplot() +
geom_sf(aes(geometry = geom,
           fill = as.character(tarifa_zero)), color = "white") +
geom_sf(data=muni_geobr_3) +
theme_light()+
scale_fill_manual(name = "Tarifa Zero?", values = c("#c57d4b", "#7e9563"), labels = c("Não", "Sim")) +
theme(legend.text = element_text(family = "serif", size = 12, hjust = 0.5, colour = "black"), 
      legend.title = element_text(family = "serif", size = 12, hjust = 0.5, colour = "black"))


```

The map below shows us more detailed the location of the cities

```{r leaflet map,  fig.align = 'center', out.width = "90%"}

# Primeiro precisamos dos dados de latitude e longitude das cidades analisadas. 
urlfile <- "https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/master/csv/municipios.csv"
cities_lat_lng <- read.csv(urlfile,encoding = "UTF-8")
# é necessário se certificar que o código de cada cidade estará em formato de texto, para o que a função left_join funcione. 
cities_lat_lng$codigo_ibge <- as.double(cities_lat_lng$codigo_ibge)

ffpt_muni_5 <- banco_completo %>% rename(codigo_ibge = cod_munic) %>% 
  left_join(cities_lat_lng, by = "codigo_ibge")

tarifa_zero <- ffpt_muni_5 %>% filter(tarifa_zero == "sim") %>% select(latitude, longitude, nome_do_municipio)

  leaflet(tarifa_zero) %>%
  addTiles() %>% 
  addMarkers(popup= tarifa_zero$nome_do_municipio)



```


## 3. Region of municipalities


```{r Região dos Municípios,fig.align = 'center', out.width = "50%"}

# Tabela com a Região dos Municípios

  banco_completo  %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate(regiao = trimws(regiao)) %>% 
  group_by(regiao) %>%
  tally() %>% 
  reactable(
      outlined = F, 
      fullWidth = F,
      bordered = T,
      striped = F,
      defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#c18d83")),
      columns = list(
      regiao = colDef("Region", minWidth = 120, align = "center"),
      n = colDef("Municipalities with Tarifa Zero", minWidth = 300, align = "center")))




```

##  4. State of municipalities

```{r UF dos municípios, fig.align = 'center', out.width = "50%"}

# Tabela com a UF dos municípios 

  banco_completo  %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate(nome_da_uf = trimws(nome_da_uf)) %>% 
  group_by(nome_da_uf) %>%
  tally() %>%
  arrange(-n) %>% 
  reactable(
      outlined = F, 
      fullWidth = F,
      bordered = TRUE,
      striped = F,
     defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#c18d83")),
      columns = list(
      nome_da_uf = colDef("Federative Unit", minWidth = 150, align = "center"),
      n = colDef("Municipalities with Tarifa Zero", minWidth = 300, align = "center")))



```

## 5. Population Class


```{r}

  banco_completo %>% 
  mutate(classe_pop = factor(classe_pop, levels = c("Up to 5.000", 
                                                    "5.000 up to 10.000", 
                                                    "10.000 up to 20.000", 
                                                    "20.000 up to 50.000",
                                                    "50.000 up to 100.000", 
                                                    "100.000 up to 500.000", 
                                                    "Greater than 500.000", ordered = TRUE))) %>% 
  group_by(tarifa_zero, classe_pop) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  mutate(classe_pop = trimws(classe_pop)) %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% 
  filter(!is.na(classe_pop)) %>% 
  mutate(tarifa_zero = case_when(tarifa_zero == "sim" ~ "Municípios com Tarifa Zero", 
                                 tarifa_zero == "não"~ "Municípios sem Tarifa Zero", TRUE ~ tarifa_zero)) %>% 
  ggplot() +
  geom_col(aes(x = reorder(classe_pop, pct), y =  pct, fill = tarifa_zero), width = 1,colour="white", alpha = 0.6) + 
  xlab("") +
  ylab("") +
  ggtitle( "") +
  facet_wrap(~tarifa_zero)+
  scale_fill_manual(name = "", values = c("gray22", "gray22"), labels = element_blank()) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  geom_label(aes(x = classe_pop, y = pct, group = tarifa_zero, label = scales::percent(pct, accuracy = 2)), 
             position = position_identity(),family = "serif", size = 4, colour = "white", fill = "#c18d83", face = "bold")+
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#c18d83"),
    strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "Lora", size = 13),
    axis.text.y=element_text(size = 10, family = "Lora"),
    axis.text.x=element_blank(),
    legend.position="none")+
    coord_flip() 


```


## 4. Year of Implementation


```{r}

banco_completo %>% 
filter(tarifa_zero == "sim") %>% 
mutate(ano_implementacao_classe = case_when(ano_implementacao <= 1998 ~ "Until 2000s", 
                                  ano_implementacao >= 2001 & ano_implementacao  <= 2009 ~ "Between 2001 and 2009",
                                  ano_implementacao >= 2010 & ano_implementacao <= 2015 ~  "Between 2010 and 2015", 
                                  ano_implementacao >= 2016 & ano_implementacao <= 2020 ~ "Between 2016 and 2020", 
                                  ano_implementacao >= 2020  ~ "After 2021", 
                                  TRUE ~ "NA")) %>% 
mutate(ano_implementacao_classe = factor(ano_implementacao_classe, levels = c("Until 2000s", 
                                                                          "Between 2001 and 2009", 
                                                                          "Between 2010 and 2015", 
                                                                          "Between 2016 and 2020",
                                                                          "After 2021", ordered = T))) %>% 
group_by(ano_implementacao_classe) %>% 
tally() %>% 
mutate(pct = n/sum(n)) %>% 
ggplot() +
  geom_col(aes(x = reorder(ano_implementacao_classe, pct), y =  pct), width = 1,colour="white", alpha = 0.6) + 
  xlab("") +
  ylab("") +
  ggtitle( "") +
  scale_fill_manual(name = "", values = c("gray22", "gray22"), labels = element_blank()) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  geom_label(aes(x = ano_implementacao_classe, y = pct, label = scales::percent(pct, accuracy = 2)), 
             position = position_identity(),family = "serif", size = 4, colour = "white", fill = "#c18d83", face = "bold")+
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#c18d83"),
    strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "Lora", size = 13),
    axis.text.y=element_text(size = 10, family = "Lora"),
    axis.text.x=element_blank(),
    legend.position="none")+
    coord_flip() 

```

---

## **Exploratory Analysis**


## 1.Análise da Teoria do Eleitor Mediano


**1° Premissa:** "Quanto maior a desigualdade, maior a exigência por serviços públicos e consequente aumento do gasto público. Portanto, cidades com tarifa zero devem ser mais desiguais do que cidades sem essa política." 

Para verificar se essa premissa de fato pode nos ajudar a explicar a tarifa zero, vejamos primeiro o Gini e o Theil-L, ambos são índices de desigualdade amplamente utilizados, medem o grau de concentração de renda em determinado grupo e variam de 0 a 1, sendo 0 uma situação de completa igualdade e 1 uma situação de completa desigualdade, nesse caso estão usando dados do censo de 2010.

```{r Indice de Gini e Theil media geral}

# Indíce de Gini médias

media_indice_gini_tf <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(median(gini)) %>% 
  round(digits = 2) %>% 
  pull()

media_indice_gini_geral <- banco_completo %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(median(gini, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()

# Indíce de  Theil 

media_indice_theil_tf <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(median(theil)) %>% 
  round(digits = 2) %>% 
  pull()

media_indice_theil_geral <- banco_completo %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(median(theil, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()



```


degree of income concentration in a given group and range from 0 to 1,
0 being a situation of complete equality, and 1 being a situation of complete
inequality, in addition both are using data from the 2010 census.
The general median of the Gini index in the studied cities is
 `r media_indice_gini_tf`, while for municipalities without a Zero Tariff it is
`r media_indice_gini_geral`. There is only a small difference in the averages. And the same is true for the
Theil-L index, where the median in the first group is `r media_indice_theil_tf`, while in the second group it is
 `r media_indice_theil_geral`, but similarly the municipalities with Tarifa Zero present values that indicate less social inequality.
Below we can see the distribution graph of the values of the two indexes for all
the municipalities with a Tarifa Zero: 


```{r Gráfico GINI e Theil 1, fig.align = 'center', out.width = "70%", dpi=300}

banco_completo %>% 
  pivot_longer(cols = c("gini", "theil")) %>%
  mutate(name = case_when(
    name == "gini" ~ "Gini",
    name == "theil" ~ "Theil-L")) %>% 
    ggplot() +
    geom_boxplot(aes(x = tarifa_zero, y = value, fill = tarifa_zero), colour="black", alpha = 0.9) + 
  facet_wrap(~name) +
  theme_light() +
  ggtitle("Boxplot do Índice de Gini e de Theil") +
  xlab("") +
  ylab("") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#c57d4b", "#7e9563"), labels = c("Não", "Sim"))+ 
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#579296"),
  strip.text.x = element_text(colour = "White", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 14),
    axis.text.x=element_blank(),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.position = "bottom")



```

Tabela Separandos os valores por UF: 


```{r}

  ffpt <- banco_completo %>% 
  filter(tarifa_zero == "sim") %>% 
  select(regiao, gini, theil) %>% 
  group_by(regiao) %>% 
  summarise(media_gini_tf = median(gini), media_theil_tf = median(theil))


# munic sem ffpt:

  banco_completo %>% 
  filter(tarifa_zero == "não") %>% 
  select(regiao, gini, theil) %>% 
  group_by(regiao) %>% 
  summarise(media_gini_geral = median(gini), media_theil_geral = median(theil)) %>% 
  left_join(ffpt, by = "regiao") %>% 
  select(regiao, media_gini_geral, media_gini_tf, media_theil_geral, media_theil_tf) %>% 
      reactable(
      fullWidth = F,
      defaultColDef = colDef(
      align = "center"),
      columns = list(
      regiao = colDef("Região", minWidth = 130),
      media_gini_tf = colDef("Cidades com Tarifa Zero", minWidth = 130),
      media_gini_geral = colDef("Cidades sem Tarifa Zero", minWidth = 130),
      media_theil_tf = colDef("Cidades com Tarifa Zero", minWidth = 130),
     media_theil_geral = colDef("Cidades sem Tarifa Zero", minWidth = 130)),
    columnGroups = list(
    colGroup(name = "Índice de Gini", columns = c("media_gini_tf", "media_gini_geral" )),
    colGroup(name = "Índice de Theil", columns = c("media_theil_geral", "media_theil_tf"))))


```


**2° Premissa:** "Quanto menor a riqueza medida através do PIB, maior a demanda por políticas redistributivas. Dessa forma, cidades com tarifa zero dispõem de menor PIB per capita do que cidades sem essa política."

Para essa análise fizemos um corte comparando apenas as cidades com até 150 mil reais de PIB per capta, tanto com tarifa zero quanto sem tarifa zero. Isso não significa retirar muitas cidades da base de dados já que 99,45% das cidades sem tarifa zero (e com menos de 300 mil habitantes) estão dentro desse valor de PIB per capita, no caso das cidades com tarifa zero, isso representa 96,4% das cidades, essa foi uma forma de retirar os valores discrepantes da análise e torná-la mais evidente. 


```{r PIB, fig.align = 'center', out.width = "70%", dpi=300}


# Gráfico

banco_completo %>% 
  rename(pib_per_capta = produto_interno_bruto_per_capita_a_precos_correntes_r_1_00) %>% 
  filter(pib_per_capta < 150000) %>% 
  ggplot() +
  geom_boxplot(aes(x = pib_per_capta, fill = tarifa_zero), colour="black", alpha = 0.9) + 
  theme_light() +
  xlab("") +
  ylab("") +
  ggtitle("Boxplot do PIB per capta") +
  scale_x_continuous(
    labels = scales::label_dollar(prefix = "R$ ",
                                  big.mark = ".")) + 
  scale_fill_manual(name = "Tarifa Zero?", values = c("#c57d4b", "#7e9563"), labels = c("Não", "Sim"))+ 
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif", size = 14),
    axis.text.x=element_blank(),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.position = "bottom")+ 
  coord_flip() 



```

























